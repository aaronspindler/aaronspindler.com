{% load static %}
{% load css_version %}
<!DOCTYPE html>
<html lang="en">

<head>
  {% include '_meta.html' %}
  <title>Aaronspindler.com - {{ blog_title }}</title>
  
  <!-- Theme detection script - prevents FOUC -->
  <script>
    (function(){
      var stored = localStorage.getItem('theme-preference');
      var theme = stored && ['light','dark'].includes(stored) ? stored : 'auto';
      document.documentElement.className = 'theme-' + theme;
    })();
  </script>
  
  {% block css %}
  {% versioned_css as css_file %}
  <link rel="stylesheet" href="{% static css_file %}">
  {% endblock %}
</head>

<body>
  {% include '_header.html' %}
  <div class="back-button">
    <a href="{% url 'home' %}#blog">Back</a>
    <br>
  </div>
  <table class="blog-metadata">
    <tr>
      <td colspan="2">{{ blog_title|safe }}</td>
    </tr>
    <tr>
      <th>Times Read</th>
      <td>{{ views }}</td>
    </tr>
    <tr>
      <th>Change Log</th>
      <td><a href="{{ github_link }}">View on Github</a></td>
    </tr>
  </table>
  {{ blog_content|safe }}
  
  <!-- Comments Section -->
  <div id="comments" class="comments-section">
    <h2>Comments ({{ comment_count }})</h2>
    
    {% if pending_comments_count and user.is_staff %}
    <div class="alert alert-info">
      <strong>Staff Notice:</strong> There are {{ pending_comments_count }} pending comments for this post.
      <a href="/admin/blog/blogcomment/?blog_template_name={{ template_name }}&status__exact=pending" target="_blank">Review in Admin</a>
    </div>
    {% endif %}
    
    {% if messages %}
    <div class="messages">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Comment Form -->
    <div class="comment-form-container">
      <h3>Leave a Comment</h3>
      {% if user.is_authenticated %}
        <p class="comment-author-info">Commenting as <strong>{{ user.username }}</strong></p>
      {% else %}
        <p class="comment-author-info">You can comment anonymously or <a href="{% url 'account_login' %}?next={{ request.path }}">login</a> to use your account.</p>
      {% endif %}
      
      <form method="post" action="{% if category %}{% url 'submit_comment_with_category' category=category template_name=template_name %}{% else %}{% url 'submit_comment' template_name=template_name %}{% endif %}" class="comment-form">
        {% csrf_token %}
        {{ comment_form.website }}  <!-- Honeypot field -->
        
        {% if not user.is_authenticated %}
        <div class="form-group">
          {{ comment_form.author_name.label_tag }}
          {{ comment_form.author_name }}
        </div>
        
        <div class="form-group">
          {{ comment_form.author_email.label_tag }}
          {{ comment_form.author_email }}
          <small class="form-text">{{ comment_form.author_email.help_text }}</small>
        </div>
        {% endif %}
        
        <div class="form-group">
          {{ comment_form.content.label_tag }}
          {{ comment_form.content }}
          <small class="form-text">{{ comment_form.content.help_text }} <span class="char-count" id="char-count-main">0 / 2000</span></small>
          {% if comment_form.content.errors %}
          <div class="form-errors">
            {{ comment_form.content.errors }}
          </div>
          {% endif %}
        </div>
        
        <button type="submit" class="btn-comment-submit">Post Comment</button>
      </form>
    </div>
    
    <!-- Display Comments -->
    <div class="comments-list">
      {% for comment in comments %}
        {% with is_reply=False depth=0 %}
          {% include "blog/comment_thread.html" %}
        {% endwith %}
      {% empty %}
      <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
      {% endfor %}
    </div>
  </div>
  
  <script>
  function toggleReplyForm(commentId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none') {
      form.style.display = 'block';
      // Focus on the textarea when opening
      var textarea = form.querySelector('.reply-textarea');
      if (textarea) textarea.focus();
    } else {
      form.style.display = 'none';
    }
  }
  
  // Character counter for main comment form
  document.addEventListener('DOMContentLoaded', function() {
    var mainTextarea = document.querySelector('.comment-form .comment-textarea');
    var mainCounter = document.getElementById('char-count-main');
    
    if (mainTextarea && mainCounter) {
      mainTextarea.addEventListener('input', function() {
        var length = this.value.length;
        mainCounter.textContent = length + ' / 2000';
        if (length > 1800) {
          mainCounter.style.color = '#ffa500';
        } else if (length >= 2000) {
          mainCounter.style.color = '#dc3545';
        } else {
          mainCounter.style.color = '';
        }
      });
    }
    
    // Auto-expand textareas as user types
    document.querySelectorAll('.comment-textarea, .reply-textarea').forEach(function(textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 400) + 'px';
      });
    });
  });
  </script>
  
  {% include '_footer.html' %}

  {% block javascript %}
  <script src="{% static 'js/theme-toggle.js' %}" defer></script>
  <script src="{% static 'js/base.js' %}" defer></script>
  {% endblock javascript %}
</body>

</html>