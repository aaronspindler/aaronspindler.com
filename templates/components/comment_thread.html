{% load static %}
<!-- Recursive comment template -->
<div class="comment {% if is_reply %}reply reply-depth-{{ depth }}{% endif %}" id="comment-{{ comment.id }}">
  <div class="comment-header">
    <div class="comment-header-left">
      <span class="comment-author">
        {% if comment.author and comment.author.is_staff %}
          <span class="staff-badge">Staff</span>
        {% endif %}
        {{ comment.get_author_display }}
      </span>
      <span class="comment-date">{{ comment.created_at|date:"F j, Y g:i A" }}</span>
      {% if comment.is_edited %}
      <span class="comment-edited">(edited)</span>
      {% endif %}
    </div>
    <div class="comment-header-right">
      <div class="comment-votes" data-comment-id="{{ comment.id }}">
        <button class="vote-btn upvote {% if comment.user_vote == 'upvote' %}active{% endif %}" 
                data-vote-type="upvote"
                onclick="voteComment({{ comment.id }}, 'upvote')"
                {% if not user.is_authenticated %}title="Login to vote"{% endif %}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V6M12 6l-7 7M12 6l7 7"></path>
          </svg>
        </button>
        
        <span class="vote-score {% if comment.score > 0 %}positive{% elif comment.score < 0 %}negative{% endif %}" data-comment-id="{{ comment.id }}">
          {% if comment.score > 0 %}+{% endif %}{{ comment.score|default:0 }}
        </span>
        
        <button class="vote-btn downvote {% if comment.user_vote == 'downvote' %}active{% endif %}" 
                data-vote-type="downvote"
                onclick="voteComment({{ comment.id }}, 'downvote')"
                {% if not user.is_authenticated %}title="Login to vote"{% endif %}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v13M12 18l7-7M12 18l-7-7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <div class="comment-content">
    {{ comment.content|linebreaks }}
  </div>
  
  <div class="comment-actions">
    <button class="btn-reply" onclick="toggleReplyForm('{{ comment.id }}')">Reply</button>
    
    {% if user.is_authenticated and user == comment.author or user.is_staff %}
    <form method="post" action="{% url 'delete_comment' comment.id %}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this comment?');">
      {% csrf_token %}
      <button type="submit" class="btn-delete">Delete</button>
    </form>
    {% endif %}
    
    {% if user.is_staff and comment.status == 'pending' %}
    <form method="post" action="{% url 'moderate_comment' comment.id %}" class="inline-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="approve">
      <button type="submit" class="btn-approve">Approve</button>
    </form>
    {% endif %}
  </div>
  
  <!-- Reply Form (hidden by default) -->
  <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
    <form method="post" action="{% url 'reply_to_comment' comment.id %}" class="reply-form">
      {% csrf_token %}
      <input type="text" name="website" style="display:none;" tabindex="-1" autocomplete="off" value=""> <!-- Honeypot -->
      {% if not user.is_authenticated %}
      <input type="text" name="author_name" placeholder="Your name (optional)" class="reply-input">
      <input type="email" name="author_email" placeholder="Your email (optional)" class="reply-input">
      {% endif %}
      <textarea name="content" placeholder="Write your reply..." rows="4" class="reply-textarea" required maxlength="2000"></textarea>
      <button type="submit" class="btn-reply-submit">Post Reply</button>
      <button type="button" class="btn-cancel" onclick="toggleReplyForm('{{ comment.id }}')">Cancel</button>
    </form>
  </div>
  
  <!-- Display Nested Replies Recursively -->
  {% if comment.get_replies %}
  <div class="replies">
    {% for reply in comment.get_replies %}
      {% with comment=reply is_reply=True depth=depth|add:1 %}
        {% include "components/comment_thread.html" %}
      {% endwith %}
    {% endfor %}
  </div>
  {% endif %}
</div>
