# Application Services
# Works for local development (builds), CI (override with images), and production

x-common-env: &common-env
  DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE:-config.settings}
  SECRET_KEY: ${SECRET_KEY:?SECRET_KEY required}
  DEBUG: ${DEBUG:-false}
  DATABASE_URL: ${DATABASE_URL}
  QUESTDB_URL: ${QUESTDB_URL}
  REDIS_URL: ${REDIS_URL}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}

x-build-config: &build-config
  context: ..
  dockerfile: deployment/Dockerfile.multistage

services:
  web:
    build:
      <<: *build-config
      target: runtime-full
    ports:
      - "${WEB_PORT:-80}:8000"
    volumes:
      - ${CODE_VOLUME:-/dev/null}:/code
      - static_volume:/code/staticfiles
      - media_volume:/code/media
    environment:
      <<: *common-env
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME:-}
      AWS_S3_REGION_NAME: ${AWS_S3_REGION_NAME:-us-east-1}
      OPENAI_KEY: ${OPENAI_KEY:-}
      ANTHROPIC_KEY: ${ANTHROPIC_KEY:-}
      MASSIVE_API_KEY: ${MASSIVE_API_KEY:-}
      RESUME_ENABLED: ${RESUME_ENABLED:-true}
      USE_LOCALSTACK: ${USE_LOCALSTACK:-false}
      TESTING_IN_DOCKER: ${TESTING_IN_DOCKER:-false}
    command: >
      sh -c "
        echo 'Waiting for services...' &&
        while ! nc -z postgres 5432; do sleep 1; done &&
        while ! nc -z redis 6379; do sleep 1; done &&
        echo 'Running migrations...' &&
        python manage.py migrate --no-input &&
        echo 'Building CSS...' &&
        python manage.py build_css || true &&
        echo 'Collecting static files...' &&
        python manage.py collectstatic --no-input || true &&
        echo 'Starting server...' &&
        ${WEB_COMMAND:-gunicorn config.wsgi:application --bind 0.0.0.0:8000}
      "
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  celery:
    build:
      <<: *build-config
      target: runtime-full
    volumes:
      - ${CODE_VOLUME:-/dev/null}:/code
    environment:
      <<: *common-env
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME:-}
      AWS_S3_REGION_NAME: ${AWS_S3_REGION_NAME:-us-east-1}
      OPENAI_KEY: ${OPENAI_KEY:-}
      ANTHROPIC_KEY: ${ANTHROPIC_KEY:-}
      USE_LOCALSTACK: ${USE_LOCALSTACK:-false}
    command: celery -A config worker -l info --concurrency=${CELERY_CONCURRENCY:-2} -Q default,notifications,heavy --events
    depends_on:
      - web

  celerybeat:
    build:
      <<: *build-config
      target: runtime-minimal
    volumes:
      - ${CODE_VOLUME:-/dev/null}:/code
    environment:
      <<: *common-env
    command: celery -A config beat -l info
    depends_on:
      - celery

  flower:
    build:
      <<: *build-config
      target: runtime-minimal
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    volumes:
      - ${CODE_VOLUME:-/dev/null}:/code
    environment:
      <<: *common-env
      FLOWER_BASIC_AUTH: ${FLOWER_BASIC_AUTH:-}
    command: celery -A config flower --port=5555 --max_tasks=50000 --persistent
    depends_on:
      - celery
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  test_runner:
    build:
      <<: *build-config
      target: test
    volumes:
      - ${CODE_VOLUME:-/dev/null}:/code
      - static_volume:/code/staticfiles
      - media_volume:/code/media
    environment:
      <<: *common-env
      DEBUG: "false"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      TESTING_IN_DOCKER: "true"
    command: >
      sh -c "
        echo 'Waiting for services...' &&
        sleep 5 &&
        echo 'Running migrations...' &&
        python manage.py migrate --no-input &&
        echo 'Running tests...' &&
        python manage.py test --keepdb --verbosity=2
      "
    mem_limit: 4g
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      questdb:
        condition: service_healthy
    profiles:
      - test

volumes:
  static_volume:
  media_volume:
