# CI/CD Testing Docker Compose
# Usage: docker compose -f docker-compose.yml -f docker-compose.ci.yml up

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: test_aaronspindler
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_aaronspindler"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  test_runner:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.multistage
      target: test
    environment:
      DJANGO_SETTINGS_MODULE: config.settings_test
      SECRET_KEY: test-secret-key
      DEBUG: "false"
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: test_aaronspindler
      POSTGRES_HOST: postgres
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      TESTING_IN_DOCKER: "true"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - test
