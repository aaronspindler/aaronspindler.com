name: Pipeline - Build, Test, Deploy

run-name: "${{ github.event.head_commit.message || github.event.pull_request.title || 'Pipeline Run' }}"

on:
  push:
    branches: [ 'main' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ '**' ]
    types: [ opened, synchronize, reopened, ready_for_review ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

# Cancel in-progress test runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SECRET_KEY: "FAKE_SECRET_KEY"
  PYTHONUNBUFFERED: 1
  DOCKER_IMAGE_NAME: test-runner
  REGISTRY: ghcr.io
  TEST_COMPOSE_FILES: -f deployment/docker-compose.yml -f deployment/docker-compose.ci.yml
  PIP_CACHE_VERSION: v1
  DOCKER_CACHE_VERSION: v2
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: testpassword

permissions:
  contents: read
  packages: write
  deployments: write

jobs:
  # ============================================================================
  # STAGE 1: Build Test Image
  # ============================================================================
  build-test-image:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v5.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host

      - name: Build test image
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: latest
          DOCKER_BUILDKIT: 1
        with:
          files: deployment/docker-bake.multistage.hcl
          targets: test
          push: false
          load: true
          set: |
            *.cache-from=type=gha,scope=buildx-test-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-to=type=gha,mode=max,scope=buildx-test-${{ env.DOCKER_CACHE_VERSION }}

      - name: Export image to tarball
        run: |
          echo "Exporting test image to tarball..."
          docker save ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:latest -o /tmp/test-image.tar
          echo "Image size: $(du -h /tmp/test-image.tar | cut -f1)"
          echo "âœ… Test image exported"

      - name: Upload image as artifact
        uses: actions/upload-artifact@v6
        with:
          name: test-image
          path: /tmp/test-image.tar
          retention-days: 1
          compression-level: 0

  # ============================================================================
  # STAGE 2: Build Production Images (Parallel with Tests)
  # ============================================================================
  build-production-images:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 8
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v5.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push production images with temporary tag
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: build-${{ github.run_id }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_INLINE_CACHE: 1
        with:
          files: deployment/docker-bake.multistage.hcl
          targets: production
          push: true
          set: |
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:prod
            *.cache-from=type=gha,scope=buildx-prod-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-to=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:prod,mode=max
            *.cache-to=type=gha,mode=max,scope=buildx-prod-${{ env.DOCKER_CACHE_VERSION }}
          provenance: false
          sbom: false

  # ============================================================================
  # STAGE 3: Run Tests
  # ============================================================================
  test-suite:
    runs-on: ubuntu-latest
    needs: [build-test-image]
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v5.0.1

      - name: Download test image artifact
        uses: actions/download-artifact@v7
        with:
          name: test-image
          path: /tmp

      - name: Load test image from tarball
        run: |
          echo "Loading test image from artifact..."
          docker load -i /tmp/test-image.tar
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:latest ${{ env.DOCKER_IMAGE_NAME }}:latest
          echo "âœ… Test image ready"

      - name: Start test services
        run: |
          echo "Starting database services..."
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE up -d postgres redis
          echo "âœ… Test services started"

      - name: Run Django checks
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          echo "Running migrations check..."
          docker compose $COMPOSE run --rm test_runner \
            python manage.py makemigrations --check --dry-run --settings=config.settings_test

          echo "Running system check..."
          docker compose $COMPOSE run --rm test_runner \
            python manage.py check --deploy --settings=config.settings_test

          echo "âœ… Django checks passed"

      - name: Run all tests
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE run --rm test_runner sh -c "
            python manage.py test accounts config pages utils blog photos \
              --settings=config.settings_test \
              --no-input \
              --verbosity=2 \
              --parallel \
              --timing
          "
          echo "âœ… All tests completed"

      - name: Cleanup test services
        if: always()
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE down -v
          echo "âœ… Test services cleaned up"

  # ============================================================================
  # STAGE 4: Tag Production Images (Only on main after tests pass)
  # ============================================================================
  tag-production-images:
    runs-on: ubuntu-latest
    needs: [test-suite, build-production-images]
    if: github.ref == 'refs/heads/main' && needs.test-suite.result == 'success'
    timeout-minutes: 5
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-tag production images with commit SHA
        run: |
          for service in web celery celerybeat flower; do
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY }}/${{ github.repository }}-${service}:${{ github.sha }} \
              ${{ env.REGISTRY }}/${{ github.repository }}-${service}:build-${{ github.run_id }} &
          done
          wait
          echo "âœ… Production images tagged with SHA: ${{ github.sha }}"

  # ============================================================================
  # STAGE 5: Create GitHub Deployment
  # ============================================================================
  create-deployment:
    runs-on: ubuntu-latest
    needs: [tag-production-images]
    if: github.ref == 'refs/heads/main' && needs.tag-production-images.result == 'success'
    timeout-minutes: 2
    outputs:
      deployment_id: ${{ steps.create-deployment.outputs.deployment_id }}
    steps:
      - name: Create GitHub Deployment
        id: create-deployment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸš€ Creating GitHub deployment..."

          # Create deployment
          deployment_id=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments \
            --input - \
            --jq '.id' <<EOF
          {
            "ref": "${{ github.sha }}",
            "environment": "production",
            "description": "Deploy commit ${{ github.sha }}",
            "auto_merge": false,
            "required_contexts": []
          }
          EOF
          )

          echo "deployment_id=${deployment_id}" >> $GITHUB_OUTPUT
          echo "âœ… Created deployment: ${deployment_id}"

          # Set initial status to pending
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${deployment_id}/statuses \
            -f state='pending' \
            -f description='Deployment starting...'

          echo "âœ… Deployment status set to pending"

  # ============================================================================
  # STAGE 6: Deploy to Production (Only on main after deployment created)
  # ============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: [create-deployment]
    if: github.ref == 'refs/heads/main' && needs.create-deployment.result == 'success'
    timeout-minutes: 10
    strategy:
      matrix:
        service:
          - name: web
            token: CAPROVER_WEB_APP_TOKEN
            app_name: CAPROVER_WEB_APP_NAME
          - name: celery
            token: CAPROVER_CELERY_APP_TOKEN
            app_name: CAPROVER_CELERY_APP_NAME
          # NOTE: celerybeat and flower are deployed separately via deploy-celery-services.yml
          # They don't need redeployment on every commit since they don't run task code
      fail-fast: false

    steps:
      - name: Set deployment status to in_progress
        if: matrix.service.name == 'web'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/deployments/${{ needs.create-deployment.outputs.deployment_id }}/statuses \
            -f state='in_progress' \
            -f description='Deploying services to production...'

      - name: Deploy ${{ matrix.service.name }} to CapRover
        run: |
          echo "ðŸš€ Deploying ${{ matrix.service.name }} to CapRover..."
          docker run caprover/cli-caprover:latest caprover deploy \
            --caproverUrl "${{ secrets.CAPROVER_SERVER }}" \
            --appToken "${{ secrets[matrix.service.token] }}" \
            --appName "${{ secrets[matrix.service.app_name] }}" \
            --imageName "${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service.name }}:${{ github.sha }}"

          if [ $? -eq 0 ]; then
            echo "âœ… ${{ matrix.service.name }} deployed successfully"
          else
            echo "âŒ ${{ matrix.service.name }} deployment failed"
            exit 1
          fi

  # ============================================================================
  # STAGE 7: Update Deployment Status
  # ============================================================================
  update-deployment-status:
    runs-on: ubuntu-latest
    needs: [create-deployment, deploy]
    if: always() && github.ref == 'refs/heads/main' && needs.create-deployment.result == 'success'
    timeout-minutes: 2
    steps:
      - name: Set deployment status
        env:
          GH_TOKEN: ${{ github.token }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          DEPLOYMENT_ID: ${{ needs.create-deployment.outputs.deployment_id }}
        run: |
          if [[ "${DEPLOY_RESULT}" == "success" ]]; then
            echo "âœ… Setting deployment status to success"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/deployments/${DEPLOYMENT_ID}/statuses \
              -f state='success' \
              -f description='All services deployed successfully' \
              -f environment_url='https://aaronspindler.com'
          else
            echo "âŒ Setting deployment status to failure"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/deployments/${DEPLOYMENT_ID}/statuses \
              -f state='failure' \
              -f description='Deployment failed - check workflow logs'
            exit 1
          fi

  # ============================================================================
  # Pipeline Summary
  # ============================================================================
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [test-suite, deploy, update-deployment-status]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Pipeline Status Report
        env:
          TEST_RESULT: ${{ needs.test-suite.result }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          DEPLOYMENT_STATUS_RESULT: ${{ needs.update-deployment-status.result }}
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Flow" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo "graph LR" >> $GITHUB_STEP_SUMMARY
          echo "    A[build-test-image] --> C[test-suite]" >> $GITHUB_STEP_SUMMARY
          echo "    B[build-production-images] --> D[tag-production-images]" >> $GITHUB_STEP_SUMMARY
          echo "    C --> D" >> $GITHUB_STEP_SUMMARY
          echo "    D --> E[create-deployment]" >> $GITHUB_STEP_SUMMARY
          echo "    E --> F[deploy]" >> $GITHUB_STEP_SUMMARY
          echo "    F --> G[update-deployment-status]" >> $GITHUB_STEP_SUMMARY
          echo "    G --> H[pipeline-summary]" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${TEST_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${DEPLOY_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Status | ${DEPLOYMENT_STATUS_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${TEST_RESULT}" == "success" && "${DEPLOY_RESULT}" == "success" && "${DEPLOYMENT_STATUS_RESULT}" == "success" ]]; then
            echo "âœ… **Pipeline completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Production deployment: LIVE**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **View deployment in GitHub: https://github.com/${{ github.repository }}/deployments**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
