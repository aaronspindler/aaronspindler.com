name: Pipeline - Build, Test, Deploy

run-name: "${{ github.event.head_commit.message || github.event.pull_request.title || 'Pipeline Run' }}"

on:
  push:
    branches: [ 'main' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ '**' ]
    types: [ opened, synchronize, reopened, ready_for_review ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

# Cancel in-progress test runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SECRET_KEY: "FAKE_SECRET_KEY"
  PYTHONUNBUFFERED: 1
  DOCKER_IMAGE_NAME: test-runner
  REGISTRY: ghcr.io
  TEST_COMPOSE_FILES: -f deployment/docker-compose.test.yml -f deployment/docker-compose.test.ci.yml
  TEST_IMAGE_TAG: test-${{ github.run_id }}
  PIP_CACHE_VERSION: v1
  DOCKER_CACHE_VERSION: v2

permissions:
  contents: read
  packages: write

jobs:
  # ============================================================================
  # STAGE 1: Build Test Image
  # ============================================================================
  build-test-image:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Checkout code
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5  # v5.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push test image to GHCR
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: ${{ env.TEST_IMAGE_TAG }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_INLINE_CACHE: 1
        with:
          files: deployment/docker-bake.multistage.hcl
          targets: test
          push: true
          set: |
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:test
            *.cache-from=type=gha,scope=buildx-test-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-to=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:test,mode=max
            *.cache-to=type=gha,mode=max,scope=buildx-test-${{ env.DOCKER_CACHE_VERSION }}

  # ============================================================================
  # STAGE 2: Build Production Images (Parallel with Tests)
  # ============================================================================
  build-production-images:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 8
    steps:
      - name: Checkout code
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5  # v5.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push production images with temporary tag
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: build-${{ github.run_id }}
          DOCKER_BUILDKIT: 1
          BUILDKIT_INLINE_CACHE: 1
        with:
          files: deployment/docker-bake.multistage.hcl
          targets: essential
          push: true
          set: |
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:prod
            *.cache-from=type=gha,scope=buildx-prod-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-to=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/cache:prod,mode=max
            *.cache-to=type=gha,mode=max,scope=buildx-prod-${{ env.DOCKER_CACHE_VERSION }}
          provenance: false
          sbom: false

  # ============================================================================
  # STAGE 3: Run Tests
  # ============================================================================
  test-suite:
    runs-on: ubuntu-latest
    needs: [build-test-image]
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@c2d88d3ecc89a9ef08eebf45d9637801dcee7eb5  # v5.0.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test image from GHCR
        run: |
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.TEST_IMAGE_TAG }}
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.TEST_IMAGE_TAG }} ${{ env.DOCKER_IMAGE_NAME }}:latest
          echo "âœ… Test image ready"

      - name: Start test services
        run: |
          echo "Starting database services..."
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE up -d postgres redis questdb
          echo "âœ… Test services started"

      - name: Run Django checks
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          echo "Running migrations check..."
          docker compose $COMPOSE run --rm test_runner \
            python manage.py makemigrations --check --dry-run --settings=config.settings_test

          echo "Running system check..."
          docker compose $COMPOSE run --rm test_runner \
            python manage.py check --deploy --settings=config.settings_test

          echo "âœ… Django checks passed"

      - name: Run all tests
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE run --rm test_runner sh -c "
            python manage.py test accounts config pages utils blog photos \
              --settings=config.settings_test \
              --no-input \
              --verbosity=2 \
              --parallel \
              --timing
          "
          echo "âœ… All tests completed"

      - name: Cleanup test services
        if: always()
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE down -v
          echo "âœ… Test services cleaned up"

  # ============================================================================
  # STAGE 4: Tag Production Images (Only on main after tests pass)
  # ============================================================================
  tag-production-images:
    runs-on: ubuntu-latest
    needs: [test-suite, build-production-images]
    if: github.ref == 'refs/heads/main' && needs.test-suite.result == 'success'
    timeout-minutes: 5
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-tag production images with commit SHA
        run: |
          for service in web celery celerybeat; do
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY }}/${{ github.repository }}-${service}:${{ github.sha }} \
              ${{ env.REGISTRY }}/${{ github.repository }}-${service}:build-${{ github.run_id }} &
          done
          wait
          echo "âœ… Production images tagged with SHA: ${{ github.sha }}"

  # ============================================================================
  # STAGE 5: Deploy to Production (Only on main after tagging)
  # ============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: [tag-production-images]
    if: github.ref == 'refs/heads/main' && needs.tag-production-images.result == 'success'
    timeout-minutes: 10
    strategy:
      matrix:
        service:
          - name: web
            token: CAPROVER_WEB_APP_TOKEN
            app_name: CAPROVER_WEB_APP_NAME
          - name: celery
            token: CAPROVER_CELERY_APP_TOKEN
            app_name: CAPROVER_CELERY_APP_NAME
          - name: celerybeat
            token: CAPROVER_CELERYBEAT_APP_TOKEN
            app_name: CAPROVER_CELERYBEAT_APP_NAME
      fail-fast: false

    steps:
      - name: Deploy ${{ matrix.service.name }} to CapRover
        run: |
          echo "ðŸš€ Deploying ${{ matrix.service.name }} to CapRover..."
          docker run caprover/cli-caprover:latest caprover deploy \
            --caproverUrl "${{ secrets.CAPROVER_SERVER }}" \
            --appToken "${{ secrets[matrix.service.token] }}" \
            --appName "${{ secrets[matrix.service.app_name] }}" \
            --imageName "${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service.name }}:${{ github.sha }}"

          if [ $? -eq 0 ]; then
            echo "âœ… ${{ matrix.service.name }} deployed successfully"
          else
            echo "âŒ ${{ matrix.service.name }} deployment failed"
            exit 1
          fi

  # ============================================================================
  # STAGE 6: Cleanup
  # ============================================================================
  cleanup-test-images:
    runs-on: ubuntu-latest
    needs: [test-suite]
    if: always()
    timeout-minutes: 5
    permissions:
      packages: write
    steps:
      - name: Delete old test images
        uses: actions/delete-package-versions@v5
        with:
          package-name: '${{ github.event.repository.name }}/test-runner'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: 'false'
        continue-on-error: true

  # ============================================================================
  # Pipeline Summary
  # ============================================================================
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [test-suite, deploy]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Pipeline Status Report
        env:
          TEST_RESULT: ${{ needs.test-suite.result }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Flow" >> $GITHUB_STEP_SUMMARY
          echo '```mermaid' >> $GITHUB_STEP_SUMMARY
          echo "graph LR" >> $GITHUB_STEP_SUMMARY
          echo "    A[build-test-image] --> C[test-suite]" >> $GITHUB_STEP_SUMMARY
          echo "    B[build-production-images] --> D[tag-production-images]" >> $GITHUB_STEP_SUMMARY
          echo "    C --> D" >> $GITHUB_STEP_SUMMARY
          echo "    D --> E[deploy]" >> $GITHUB_STEP_SUMMARY
          echo "    E --> F[pipeline-summary]" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${TEST_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${DEPLOY_RESULT} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${TEST_RESULT}" == "success" && "${DEPLOY_RESULT}" == "success" ]]; then
            echo "âœ… **Pipeline completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Production deployment: LIVE**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pipeline failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
