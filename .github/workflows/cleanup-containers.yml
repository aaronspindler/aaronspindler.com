name: Housekeeping - Container Registry Cleanup

on:
  workflow_run:
    workflows: ["Deploy to Production"]
    types: [completed]
    branches: [main]

  # Also run weekly as a backup
  schedule:
    - cron: '0 3 * * 1'  # Every Monday at 3 AM UTC

  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded or if manually triggered/scheduled
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      packages: write
      contents: read

    strategy:
      matrix:
        package:
          - aaronspindler.com-web
          - aaronspindler.com-celery
          - aaronspindler.com-celerybeat
          - aaronspindler.com-flower

    steps:
      - name: Delete old versions of ${{ matrix.package }}
        uses: actions/delete-package-versions@v5
        with:
          package-name: '${{ matrix.package }}'
          package-type: 'container'
          min-versions-to-keep: 5
          delete-only-untagged-versions: 'false'

      - name: Delete untagged versions of ${{ matrix.package }}
        uses: actions/delete-package-versions@v5
        with:
          package-name: '${{ matrix.package }}'
          package-type: 'container'
          delete-only-untagged-versions: 'true'
          min-versions-to-keep: 1
