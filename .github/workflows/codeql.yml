name: "CodeQL"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '30 5 * * *'  # Runs at 5:30 AM UTC every day

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: write  # Required to create commits and PRs
      security-events: write
      pull-requests: write  # Required for Copilot Autofix to post suggestions

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python', 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        config-file: ./.github/codeql/codeql-config.yml

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{ matrix.language }}"

  # Job to create PRs with autofix suggestions
  autofix:
    name: Create Autofix PRs
    needs: analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    permissions:
      contents: write
      pull-requests: write
      security-events: read
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Get CodeQL alerts with autofix suggestions
      id: get-alerts
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Fetch code scanning alerts
        alerts=$(gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository }}/code-scanning/alerts \
          --jq '[.[] | select(.state == "open" and .tool.name == "CodeQL")]')

        alert_count=$(echo "$alerts" | jq 'length')
        echo "alert-count=$alert_count" >> $GITHUB_OUTPUT

        if [ "$alert_count" -gt 0 ]; then
          echo "has-alerts=true" >> $GITHUB_OUTPUT
          echo "Found $alert_count open CodeQL alerts"

          # Save alert details for PR body
          echo "$alerts" | jq -r '.[] | "- **\(.rule.description)** (\(.rule.severity))\n  File: \(.most_recent_instance.location.path):\(.most_recent_instance.location.start_line)\n  Message: \(.most_recent_instance.message.text)\n"' > alert_details.txt
        else
          echo "has-alerts=false" >> $GITHUB_OUTPUT
          echo "No open CodeQL alerts found"
        fi

    - name: Create PR for CodeQL fixes
      if: steps.get-alerts.outputs.has-alerts == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Create a new branch for autofix
        branch_name="codeql-autofix-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$branch_name"

        alert_count="${{ steps.get-alerts.outputs.alert-count }}"

        # Create a marker file to indicate this PR is for CodeQL fixes
        mkdir -p .github/codeql-autofix
        echo "This branch contains automated fixes for CodeQL security alerts." > .github/codeql-autofix/README.md
        echo "" >> .github/codeql-autofix/README.md
        echo "## Detected Issues" >> .github/codeql-autofix/README.md
        echo "" >> .github/codeql-autofix/README.md
        cat alert_details.txt >> .github/codeql-autofix/README.md

        git add .github/codeql-autofix/README.md
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "docs: CodeQL security alerts detected

        This PR is automatically created to address $alert_count CodeQL security alert(s).

        GitHub Copilot Autofix will analyze these alerts and provide suggested fixes
        in the PR comments. Please review and apply the suggested fixes.

        See the Security tab for detailed information about each alert."

        git push origin "$branch_name"

        # Create PR with detailed body
        pr_body="## ðŸ”’ CodeQL Security Alerts Detected

        This PR was automatically created because CodeQL detected **$alert_count** security alert(s) in the codebase.

        ### What happens next?

        1. **GitHub Copilot Autofix** will analyze these alerts and post suggested fixes as PR comments
        2. Review each suggestion carefully
        3. Apply the fixes by accepting the suggestions or implementing your own solution
        4. Once all issues are resolved, merge this PR

        ### Detected Issues

        $(cat alert_details.txt)

        ### Additional Resources

        - [View all alerts in Security tab](https://github.com/${{ github.repository }}/security/code-scanning)
        - [CodeQL documentation](https://codeql.github.com/docs/)
        - [GitHub Copilot Autofix docs](https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-autofix-for-codeql-code-scanning)

        ---
        *This PR was automatically created by the CodeQL workflow on $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"

        gh pr create \
          --title "ðŸ”’ Security: Fix $alert_count CodeQL alert(s)" \
          --body "$pr_body" \
          --base main \
          --head "$branch_name" \
          --label "security,codeql,automated"

        echo "âœ… Created PR for CodeQL autofix suggestions"
