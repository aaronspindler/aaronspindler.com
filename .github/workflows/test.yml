name: Pipeline - Tests

run-name: "${{ github.event.head_commit.message || github.event.pull_request.title || 'Run Tests' }}"

on:
  push:
    branches: [ 'main' ]  # Only run on direct pushes to main
    paths-ignore:  # Skip workflow for documentation-only changes
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ '**' ]  # Run on all PRs
    types: [ opened, synchronize, reopened, ready_for_review ]
    paths-ignore:  # Skip workflow for documentation-only changes
      - '**.md'
      - 'docs/**'
      - '.cursor/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

# Cancel in-progress test runs for fast feedback
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SECRET_KEY: "FAKE_SECRET_KEY"
  PYTHONUNBUFFERED: 1
  DOCKER_IMAGE_NAME: test-runner
  DOCKER_IMAGE_ARCHIVE: test-runner-image.tar.gz
  REGISTRY: ghcr.io
  TEST_COMPOSE_FILES: -f deployment/docker-compose.test.yml -f deployment/docker-compose.test.ci.yml
  # Cache versions - bump these to invalidate caches
  PIP_CACHE_VERSION: v1
  DOCKER_CACHE_VERSION: v1

permissions:
  contents: read

jobs:
  # Build Docker image once and share it with other jobs
  build-docker-image:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1

      - name: Verify Docker Compose file
        run: |
          if [ ! -f deployment/docker-compose.test.yml ]; then
            echo "‚ùå deployment/docker-compose.test.yml not found!"
            exit 1
          fi
          echo "‚úÖ deployment/docker-compose.test.yml found"

      - name: Log in to GitHub Container Registry (for cache)
        if: github.event_name != 'pull_request'
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image with Bake
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: test
        with:
          files: deployment/docker-bake.hcl
          targets: test
          load: true
          set: |
            *.cache-from=type=gha,scope=test-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}/test-runner:cache
            *.cache-to=type=gha,mode=max,scope=test-${{ env.DOCKER_CACHE_VERSION }}

      - name: Install pigz for fast compression
        run: |
          sudo apt-get update && sudo apt-get install -y pigz

      - name: Save Docker image to file with optimized compression
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | pigz -6 > "${{ env.DOCKER_IMAGE_ARCHIVE }}"
          echo "üì¶ Compressed image size: $(du -h "${{ env.DOCKER_IMAGE_ARCHIVE }}" | cut -f1)"
          echo "Available images:"
          docker images | grep test-runner || true

      - name: Upload Docker image as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: docker-image
          path: ${{ env.DOCKER_IMAGE_ARCHIVE }}
          retention-days: 1
          compression-level: 0  # Already compressed with pigz

  # Build production images in parallel with tests (cached, not pushed until all tests pass)
  build-production-images:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build production images (cache only, don't push)
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: ${{ github.sha }}
        with:
          files: deployment/docker-bake.hcl
          targets: production
          push: false
          set: |
            *.cache-from=type=gha,scope=buildx-main-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-from=type=gha
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
            *.cache-to=type=gha,mode=max,scope=buildx-main-${{ env.DOCKER_CACHE_VERSION }}
          provenance: false
          sbom: false

  django-checks:
    runs-on: ubuntu-latest
    needs: build-docker-image
    timeout-minutes: 10
    strategy:
      matrix:
        check: [migrations, system]
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Download Docker image artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: docker-image
          path: /tmp

      - name: Install pigz for fast decompression
        run: |
          sudo apt-get update && sudo apt-get install -y pigz

      - name: Load Docker image with optimized decompression
        run: |
          echo "Loading Docker image..."
          pigz -dc "/tmp/${{ env.DOCKER_IMAGE_ARCHIVE }}" | docker load
          docker images | grep test-runner

      - name: Start required services
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          export COMPOSE
          docker compose $COMPOSE up -d postgres redis questdb
          echo "Waiting for services to be healthy..."
          timeout 90s bash -c "until docker compose \$COMPOSE ps --format json | grep -q '\"Health\":\"healthy\"'; do echo 'Waiting for services...'; sleep 2; done" || echo "Warning: Services health check timed out"
          echo "Service status:"
          docker compose $COMPOSE ps

      - name: Run Django ${{ matrix.check }} check
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          case "${{ matrix.check }}" in
            migrations)
              docker compose $COMPOSE run --rm test_runner \
                python manage.py makemigrations --check --dry-run --settings=config.settings_test
              ;;
            system)
              docker compose $COMPOSE run --rm test_runner \
                python manage.py check --deploy --settings=config.settings_test
              ;;
          esac

      - name: Cleanup
        if: always()
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE down -v

  test-suite:
    runs-on: ubuntu-latest
    needs: build-docker-image
    timeout-minutes: 30  # Increased timeout for memory-intensive tests
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - name: "core"
            apps: "accounts pages config"
          - name: "blog"
            apps: "blog"
          - name: "photos"
            apps: "photos"
          - name: "utils"
            apps: "utils"
          # - name: "feefifofunds"
          #   apps: "feefifofunds"
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Download Docker image artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: docker-image
          path: /tmp

      - name: Install pigz for fast decompression
        run: |
          sudo apt-get update && sudo apt-get install -y pigz

      - name: Load Docker image with optimized decompression
        run: |
          echo "Loading Docker image..."
          pigz -dc "/tmp/${{ env.DOCKER_IMAGE_ARCHIVE }}" | docker load
          docker images | grep test-runner

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ runner.os }}-pip-${{ env.PIP_CACHE_VERSION }}-${{ hashFiles('requirements/*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PIP_CACHE_VERSION }}-

      - name: Start test services
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          export COMPOSE
          docker compose $COMPOSE up -d postgres redis questdb
          echo "Waiting for services to be healthy..."
          timeout 90s bash -c "until docker compose \$COMPOSE ps --format json | grep -q '\"Health\":\"healthy\"'; do echo 'Waiting for services...'; sleep 2; done" || echo "Warning: Services health check timed out"
          echo "Service status:"
          docker compose $COMPOSE ps

      - name: Run tests for ${{ matrix.test-group.name }}
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          mkdir -p ./test_output
          docker compose $COMPOSE run --rm \
            -v $(pwd)/test_output:/code/test_output \
            -v $(pwd)/pyproject.toml:/code/pyproject.toml:ro \
            -v ~/.cache/pip:/root/.cache/pip \
            test_runner sh -c "
            pip install coverage unittest-xml-reporting --no-cache-dir --root-user-action=ignore &&
            export PYTHONDONTWRITEBYTECODE=1 &&
            export PYTHONUNBUFFERED=1 &&
            export COVERAGE_RCFILE=/code/pyproject.toml &&
            export TEST_OUTPUT_DIR=/code/test_output/test-results-${{ matrix.test-group.name }} &&
            coverage run manage.py test ${{ matrix.test-group.apps }} \
              --settings=config.settings_test \
              --no-input \
              --verbosity=2 &&
            coverage report &&
            coverage xml -o /code/test_output/coverage-${{ matrix.test-group.name }}.xml
          "

      - name: Upload coverage artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: coverage-${{ matrix.test-group.name }}
          path: ./test_output/coverage-${{ matrix.test-group.name }}.xml
          retention-days: 1

      - name: Upload test results artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: test-results-${{ matrix.test-group.name }}
          path: ./test_output/test-results-${{ matrix.test-group.name }}/
          retention-days: 1

      - name: Cleanup
        if: always()
        run: |
          COMPOSE="${{ env.TEST_COMPOSE_FILES }}"
          docker compose $COMPOSE down -v

  coverage-upload:
    runs-on: ubuntu-latest
    needs: test-suite
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Download coverage artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: coverage-*
          merge-multiple: true
          path: ./coverage-reports

      - name: Download test results artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: test-results-*
          merge-multiple: true
          path: ./test-results

      - name: Set up Python
        uses: actions/setup-python@bfc4944b43a5d84377eca3cf6ab5b7992ba61923  # v6.0.0
        with:
          python-version: '3.12.2'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.local
          key: ${{ runner.os }}-pip-coverage-${{ env.PIP_CACHE_VERSION }}-${{ hashFiles('requirements/*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-coverage-${{ env.PIP_CACHE_VERSION }}-

      - name: Install coverage
        run: |
          pip install coverage

      - name: Merge coverage files
        run: |
          ls -la ./coverage-reports/
          if ls ./coverage-reports/coverage-*.xml 1> /dev/null 2>&1; then
            cp ./coverage-reports/coverage-*.xml .
            echo "Found coverage files:"
            ls -la coverage-*.xml
          else
            echo "No coverage files found, creating empty one"
            echo '<?xml version="1.0"?><coverage></coverage>' > coverage.xml
          fi

      - name: Upload to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5.5.1
        with:
          files: ./coverage-*.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        uses: codecov/test-results-action@v1  # v1.1.1
        with:
          files: ./test-results/**/*.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  cleanup-artifacts:
    runs-on: ubuntu-latest
    needs: [django-checks, test-suite]
    if: always() && (needs.django-checks.result == 'failure' || needs.test-suite.result == 'failure')
    steps:
      - name: Delete Docker image artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: docker-image
          failOnError: false

      - name: Delete coverage artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            coverage-*
            test-results-*
          failOnError: false

  # Final check to ensure all jobs passed (gate before pushing images)
  all-checks:
    runs-on: ubuntu-latest
    needs: [build-docker-image, django-checks, test-suite, coverage-upload, build-production-images]
    if: always()
    steps:
      - name: Check if all jobs passed
        run: |
          BUILD_STATUS="${{ needs.build-docker-image.result }}"
          if [[ "$BUILD_STATUS" != "success" ]]; then
            echo "‚ùå Docker build failed (status: $BUILD_STATUS)"
            exit 1
          fi

          DJANGO_STATUS="${{ needs.django-checks.result }}"
          if [[ "$DJANGO_STATUS" != "success" ]]; then
            echo "‚ùå Django checks failed (status: $DJANGO_STATUS)"
            exit 1
          fi

          TEST_STATUS="${{ needs.test-suite.result }}"
          if [[ "$TEST_STATUS" != "success" ]]; then
            echo "‚ùå Test suite failed (status: $TEST_STATUS)"
            exit 1
          fi

          COVERAGE_STATUS="${{ needs.coverage-upload.result }}"
          if [[ "$COVERAGE_STATUS" != "success" ]]; then
            echo "‚ùå Coverage upload failed (status: $COVERAGE_STATUS)"
            exit 1
          fi

          PROD_BUILD_STATUS="${{ needs.build-production-images.result }}"

          # Only fail if production build ran and failed (skip if it was skipped for PRs)
          if [[ "$PROD_BUILD_STATUS" != "success" && "$PROD_BUILD_STATUS" != "skipped" ]]; then
            echo "‚ùå Production image build failed (status: $PROD_BUILD_STATUS)"
            exit 1
          fi

          if [[ "$PROD_BUILD_STATUS" == "skipped" ]]; then
            echo "‚è≠Ô∏è  Production image build skipped (not on main branch)"
          else
            echo "‚úÖ Production images built in parallel with tests"
          fi

          echo "‚úÖ All checks passed successfully!"

  # Push production images from cache after all checks pass
  push-production-images:
    runs-on: ubuntu-latest
    needs: [all-checks]
    if: github.ref == 'refs/heads/main' && needs.all-checks.result == 'success'
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push production images from cache
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c  # v5.10.0
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_PREFIX: ${{ github.repository }}
          TAG: ${{ github.sha }}
        with:
          files: deployment/docker-bake.hcl
          targets: production
          push: true
          set: |
            *.cache-from=type=gha,scope=buildx-main-${{ env.DOCKER_CACHE_VERSION }}
            *.cache-from=type=gha
            *.cache-from=type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
            *.cache-to=type=gha,mode=max,scope=buildx-main-${{ env.DOCKER_CACHE_VERSION }}
          provenance: false
          sbom: false
