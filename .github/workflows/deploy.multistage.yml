name: Pipeline - Deploy (Multi-Stage)

run-name: "${{ github.event.workflow_run.head_commit.message || github.event.head_commit.message || 'Deploy' }}"

on:
  workflow_run:
    workflows: ["Pipeline - Tests"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

# Do NOT cancel in-progress builds/deployments for safety
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

permissions:
  contents: read

jobs:
  # Deploy pre-built images to CapRover (2 services instead of 4)
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run if the triggering workflow succeeded or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read

    strategy:
      matrix:
        service:
          - name: web
            token: CAPROVER_WEB_APP_TOKEN
            app_name: CAPROVER_WEB_APP_NAME
          - name: celery
            token: CAPROVER_CELERY_APP_TOKEN
            app_name: CAPROVER_CELERY_APP_NAME
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1
        with:
          fetch-depth: 2

      - name: Determine commit SHA
        id: commit
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # Get SHA from the workflow that triggered this deployment
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          else
            # Manual trigger - use current SHA
            COMMIT_SHA="${{ github.sha }}"
          fi
          echo "sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying images tagged with: ${COMMIT_SHA}"

      - name: Deploy ${{ matrix.service.name }} to CapRover
        continue-on-error: true
        run: |
          echo "ðŸš€ Deploying ${{ matrix.service.name }} service to CapRover..."
          docker run caprover/cli-caprover:latest caprover deploy \
            --caproverUrl "${{ secrets.CAPROVER_SERVER }}" \
            --appToken "${{ secrets[matrix.service.token] }}" \
            --appName "${{ secrets[matrix.service.app_name] }}" \
            --imageName "${{ env.REGISTRY }}/${{ github.repository }}-${{ matrix.service.name }}:${{ steps.commit.outputs.sha }}"

  # Optional: Deploy Flower on-demand (comment out if not needed)
  # deploy-flower:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 5
  #   if: github.event_name == 'workflow_dispatch'
  #   steps:
  #     - name: Deploy Flower monitoring
  #       run: |
  #         docker run caprover/cli-caprover:latest caprover deploy \
  #           --caproverUrl "${{ secrets.CAPROVER_SERVER }}" \
  #           --appToken "${{ secrets.CAPROVER_FLOWER_APP_TOKEN }}" \
  #           --appName "${{ secrets.CAPROVER_FLOWER_APP_NAME }}" \
  #           --imageName "${{ env.REGISTRY }}/${{ github.repository }}-flower:${{ github.sha }}"
