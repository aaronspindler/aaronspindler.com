name: Dependabot Regenerate Lockfiles

run-name: "Regenerate uv lockfiles for Dependabot PR"

on:
  pull_request:
    paths:
      - 'requirements/*.in'
    types: [opened, synchronize]

# Only run one instance per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate-lockfiles:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v5.0.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          # Use GITHUB_TOKEN for Dependabot PRs - this should work for public repos
          # If this fails with permission errors, you may need to create a PAT with
          # 'repo' scope and use: token: ${{ secrets.DEPENDABOT_PAT }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.0.0
        with:
          python-version: '3.13'

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Regenerate lockfiles
        run: |
          echo "ðŸ”„ Regenerating requirements/base.txt..."
          uv pip compile requirements/base.in -o requirements/base.txt --generate-hashes
          echo "âœ… base.txt regenerated"

          echo "ðŸ”„ Regenerating requirements/dev.txt..."
          uv pip compile requirements/dev.in -o requirements/dev.txt --generate-hashes
          echo "âœ… dev.txt regenerated"

          echo "Note: Both lockfiles are always regenerated to ensure consistency"

      - name: Deduplicate hashes
        run: |
          echo "ðŸ” Checking for duplicate hashes..."

          for file in requirements/base.txt requirements/dev.txt; do
            if [ -f "$file" ]; then
              echo "Processing $file..."
              # Remove consecutive duplicate lines (which are the hash duplicates)
              # This handles cases where uv pip compile generates duplicate hashes
              uniq "$file" > "${file}.tmp"
              mv "${file}.tmp" "$file"
              echo "âœ… Deduplicated hashes in $file"
            fi
          done

      - name: Check for lockfile changes
        id: lockfile_changes
        run: |
          if git diff --quiet requirements/*.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No lockfile changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Lockfile changes detected"
            echo "Changed files:"
            git diff --name-only requirements/*.txt
          fi

      - name: Commit regenerated lockfiles
        if: steps.lockfile_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add requirements/*.txt
          git commit -m "chore(deps): Regenerate uv lockfiles

          Auto-generated by dependabot-lockfile-regen workflow
          Triggered by changes to .in files"
          git push

      - name: Add comment to PR
        if: steps.lockfile_changes.outputs.has_changes == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Lockfiles have been automatically regenerated with `uv pip compile`.\n\nThe following files were updated:\n- `requirements/base.txt`\n- `requirements/dev.txt`'
            })

      - name: Summary
        if: always()
        run: |
          echo "## Lockfile Regeneration Summary" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.lockfile_changes.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… Lockfiles regenerated and committed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  No lockfile changes needed (already up to date)" >> $GITHUB_STEP_SUMMARY
          fi
