name: Cleanup Old Workflow Runs

on:
  # Run weekly on Sunday at 3 AM UTC
  schedule:
    - cron: '0 3 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      retain_days:
        description: 'Keep runs newer than this many days'
        required: false
        default: '30'
        type: string
      keep_minimum_runs:
        description: 'Minimum number of runs to keep per workflow'
        required: false
        default: '10'
        type: string

jobs:
  # First job: discover all workflows to process
  discover:
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.get-workflows.outputs.workflows }}
      workflow_count: ${{ steps.get-workflows.outputs.count }}
    permissions:
      actions: read
      contents: read

    steps:
      - name: Get workflow IDs and names
        id: get-workflows
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Discovering workflows in repository..."
          WORKFLOWS=$(gh workflow list --repo ${{ github.repository }} --json id,name -q '[.[] | {id: .id, name: .name}]')
          COUNT=$(echo "$WORKFLOWS" | jq 'length')

          echo "workflows=$WORKFLOWS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "Found $COUNT workflows to process"

  # Second job: cleanup workflows in parallel
  cleanup:
    needs: discover
    if: needs.discover.outputs.workflow_count > 0
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    strategy:
      matrix:
        workflow: ${{ fromJson(needs.discover.outputs.workflows) }}
      max-parallel: 5  # Process 5 workflows simultaneously
      fail-fast: false  # Continue even if one workflow fails

    steps:
      - name: Cleanup workflow "${{ matrix.workflow.name }}"
        env:
          GH_TOKEN: ${{ github.token }}
          RETAIN_DAYS: ${{ inputs.retain_days }}
          KEEP_MIN: ${{ inputs.keep_minimum_runs }}
          WORKFLOW_ID: ${{ matrix.workflow.id }}
          WORKFLOW_NAME: ${{ matrix.workflow.name }}
        run: |
          # Set defaults only if not provided (allow explicit 0)
          RETAIN_DAYS=${RETAIN_DAYS:-30}
          if [ -z "$KEEP_MIN" ]; then
            KEEP_MIN=10
          fi

          echo "ðŸ§¹ Processing workflow: $WORKFLOW_NAME (ID: $WORKFLOW_ID)"

          if [ "$KEEP_MIN" -eq 0 ]; then
            echo "   Mode: Delete ALL runs older than $RETAIN_DAYS days (no minimum protection)"
          else
            echo "   Mode: Delete runs older than $RETAIN_DAYS days (keeping at least $KEEP_MIN)"
          fi

          # Calculate cutoff date
          CUTOFF_DATE=$(date -u -d "$RETAIN_DAYS days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-${RETAIN_DAYS}d +%Y-%m-%dT%H:%M:%SZ)
          echo "   Cutoff date: $CUTOFF_DATE"

          # Get total run count for this workflow
          TOTAL_RUNS=$(gh run list --workflow $WORKFLOW_ID --repo ${{ github.repository }} --limit 1000 --json databaseId -q '. | length')
          echo "   Total runs: $TOTAL_RUNS"

          # Get old runs (older than cutoff date)
          OLD_RUNS=$(gh run list \
            --workflow $WORKFLOW_ID \
            --repo ${{ github.repository }} \
            --limit 1000 \
            --json databaseId,createdAt,status \
            --jq "[.[] | select(.createdAt < \"$CUTOFF_DATE\")] | .[].databaseId")

          OLD_COUNT=$(echo "$OLD_RUNS" | grep -c . || echo 0)

          if [ $OLD_COUNT -eq 0 ]; then
            echo "   âœ“ No old runs to delete"
            echo "deleted=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Calculate how many we can delete while keeping minimum (skip if KEEP_MIN is 0)
          if [ $KEEP_MIN -gt 0 ]; then
            RUNS_AFTER_DELETE=$((TOTAL_RUNS - OLD_COUNT))
            if [ $RUNS_AFTER_DELETE -lt $KEEP_MIN ]; then
              CAN_DELETE=$((TOTAL_RUNS - KEEP_MIN))
              if [ $CAN_DELETE -le 0 ]; then
                echo "   â­ï¸  Skipping: Would go below minimum of $KEEP_MIN runs"
                echo "deleted=0" >> $GITHUB_OUTPUT
                exit 0
              fi
              echo "   âš ï¸  Found $OLD_COUNT old runs, but only deleting $CAN_DELETE to keep minimum of $KEEP_MIN"
              OLD_RUNS=$(echo "$OLD_RUNS" | head -n $CAN_DELETE)
              OLD_COUNT=$CAN_DELETE
            fi
          fi

          echo "   ðŸ—‘ï¸  Deleting $OLD_COUNT old runs..."
          DELETED=0
          FAILED=0
          for RUN_ID in $OLD_RUNS; do
            if gh run delete $RUN_ID --repo ${{ github.repository }} 2>&1; then
              DELETED=$((DELETED + 1))
            else
              FAILED=$((FAILED + 1))
              echo "   âš ï¸  Failed to delete run $RUN_ID"
            fi
          done

          echo "   âœ… Deleted $DELETED runs from '$WORKFLOW_NAME'"
          if [ $FAILED -gt 0 ]; then
            echo "   âš ï¸  Failed to delete $FAILED runs"
          fi
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT

  # Third job: summary
  summary:
    needs: [discover, cleanup]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    steps:
      - name: Generate summary
        env:
          RETAIN_DAYS: ${{ inputs.retain_days }}
          KEEP_MIN: ${{ inputs.keep_minimum_runs }}
          WORKFLOW_COUNT: ${{ needs.discover.outputs.workflow_count }}
        run: |
          RETAIN_DAYS=${RETAIN_DAYS:-30}
          if [ -z "$KEEP_MIN" ]; then
            KEEP_MIN=10
          fi

          echo "### ðŸ§¹ Workflow Run Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Retention period: $RETAIN_DAYS days" >> $GITHUB_STEP_SUMMARY
          if [ "$KEEP_MIN" -eq 0 ]; then
            echo "- Minimum runs per workflow: None (delete all old runs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Minimum runs per workflow: $KEEP_MIN" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Processing mode: Parallel (max 5 concurrent workflows)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Workflows processed: $WORKFLOW_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.cleanup.result }}" >> $GITHUB_STEP_SUMMARY
