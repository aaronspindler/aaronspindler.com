name: Cleanup Old Workflow Runs

on:
  # Run weekly on Sunday at 3 AM UTC
  schedule:
    - cron: '0 3 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      retain_days:
        description: 'Keep runs newer than this many days'
        required: false
        default: '30'
        type: string
      keep_minimum_runs:
        description: 'Minimum number of runs to keep per workflow'
        required: false
        default: '10'
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Cleanup old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          RETAIN_DAYS: ${{ inputs.retain_days }}
          KEEP_MIN: ${{ inputs.keep_minimum_runs }}
        run: |
          # Set defaults only if not provided (allow explicit 0)
          RETAIN_DAYS=${RETAIN_DAYS:-30}
          if [ -z "$KEEP_MIN" ]; then
            KEEP_MIN=10
          fi

          if [ "$KEEP_MIN" -eq 0 ]; then
            echo "ðŸ§¹ Cleaning up ALL workflow runs older than $RETAIN_DAYS days (no minimum protection)"
          else
            echo "ðŸ§¹ Cleaning up workflow runs older than $RETAIN_DAYS days (keeping at least $KEEP_MIN per workflow)"
          fi

          # Calculate cutoff date
          CUTOFF_DATE=$(date -u -d "$RETAIN_DAYS days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-${RETAIN_DAYS}d +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: $CUTOFF_DATE"

          # Get all workflows
          WORKFLOWS=$(gh workflow list --repo ${{ github.repository }} --json name,id -q '.[] | .id')

          TOTAL_DELETED=0
          for WORKFLOW_ID in $WORKFLOWS; do
            echo ""
            echo "ðŸ“‹ Processing workflow ID: $WORKFLOW_ID"

            # Get total run count for this workflow
            TOTAL_RUNS=$(gh run list --workflow $WORKFLOW_ID --repo ${{ github.repository }} --limit 1000 --json databaseId -q '. | length')
            echo "   Total runs: $TOTAL_RUNS"

            # Get old runs (older than cutoff date)
            OLD_RUNS=$(gh run list \
              --workflow $WORKFLOW_ID \
              --repo ${{ github.repository }} \
              --limit 1000 \
              --json databaseId,createdAt,status \
              --jq "[.[] | select(.createdAt < \"$CUTOFF_DATE\")] | .[].databaseId")

            OLD_COUNT=$(echo "$OLD_RUNS" | grep -c . || echo 0)

            if [ $OLD_COUNT -eq 0 ]; then
              echo "   âœ“ No old runs to delete"
              continue
            fi

            # Calculate how many we can delete while keeping minimum (skip if KEEP_MIN is 0)
            if [ $KEEP_MIN -gt 0 ]; then
              RUNS_AFTER_DELETE=$((TOTAL_RUNS - OLD_COUNT))
              if [ $RUNS_AFTER_DELETE -lt $KEEP_MIN ]; then
                CAN_DELETE=$((TOTAL_RUNS - KEEP_MIN))
                if [ $CAN_DELETE -le 0 ]; then
                  echo "   â­ï¸  Skipping: Would go below minimum of $KEEP_MIN runs"
                  continue
                fi
                echo "   âš ï¸  Found $OLD_COUNT old runs, but only deleting $CAN_DELETE to keep minimum of $KEEP_MIN"
                OLD_RUNS=$(echo "$OLD_RUNS" | head -n $CAN_DELETE)
                OLD_COUNT=$CAN_DELETE
              fi
            fi

            echo "   ðŸ—‘ï¸  Deleting $OLD_COUNT old runs..."
            DELETED=0
            for RUN_ID in $OLD_RUNS; do
              if gh run delete $RUN_ID --repo ${{ github.repository }} 2>/dev/null; then
                DELETED=$((DELETED + 1))
              fi
            done

            echo "   âœ… Deleted $DELETED runs"
            TOTAL_DELETED=$((TOTAL_DELETED + DELETED))
          done

          echo ""
          echo "âœ¨ Cleanup complete! Deleted $TOTAL_DELETED runs total"

      - name: Summary
        env:
          RETAIN_DAYS: ${{ inputs.retain_days }}
          KEEP_MIN: ${{ inputs.keep_minimum_runs }}
        run: |
          RETAIN_DAYS=${RETAIN_DAYS:-30}
          if [ -z "$KEEP_MIN" ]; then
            KEEP_MIN=10
          fi

          echo "### Workflow Run Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention period**: $RETAIN_DAYS days" >> $GITHUB_STEP_SUMMARY
          if [ "$KEEP_MIN" -eq 0 ]; then
            echo "- **Minimum runs per workflow**: None (delete all old runs)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Minimum runs per workflow**: $KEEP_MIN" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: âœ… Cleanup completed successfully" >> $GITHUB_STEP_SUMMARY
