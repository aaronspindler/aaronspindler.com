{% extends '_base.html' %}
{% load static %}

{% block title %}Bulk Photo Upload{% endblock title %}

{% block css %}
{{ block.super }}
<style>
    .upload-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
    }

    .upload-header {
        margin-bottom: 30px;
    }

    .upload-header h1 {
        margin: 0 0 10px 0;
    }

    .upload-settings {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .setting-group {
        margin-bottom: 15px;
    }

    .setting-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .setting-group select,
    .setting-group input[type="checkbox"] {
        margin-right: 10px;
    }

    .drop-zone {
        border: 3px dashed #ccc;
        border-radius: 8px;
        padding: 60px 20px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }

    .drop-zone.dragover {
        border-color: #007bff;
        background: #e7f3ff;
    }

    .drop-zone:hover {
        border-color: #999;
    }

    .drop-zone-icon {
        font-size: 48px;
        margin-bottom: 10px;
        color: #999;
    }

    .drop-zone-text {
        font-size: 18px;
        color: #666;
        margin-bottom: 10px;
    }

    .drop-zone-subtext {
        font-size: 14px;
        color: #999;
    }

    .upload-progress {
        margin-top: 30px;
    }

    .overall-progress {
        margin-bottom: 20px;
    }

    .overall-progress-bar {
        height: 30px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .overall-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .overall-stats {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #666;
    }

    .file-list {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        gap: 10px;
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .file-icon {
        font-size: 24px;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-size {
        font-size: 12px;
        color: #999;
    }

    .file-progress {
        flex: 0 0 200px;
    }

    .file-progress-bar {
        height: 20px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 2px;
    }

    .file-progress-fill {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
    }

    .file-progress-fill.success {
        background: #28a745;
    }

    .file-progress-fill.error {
        background: #dc3545;
    }

    .file-progress-fill.duplicate {
        background: #ffc107;
    }

    .file-status {
        font-size: 12px;
        color: #666;
    }

    .file-status.success {
        color: #28a745;
    }

    .file-status.error {
        color: #dc3545;
    }

    .file-status.duplicate {
        color: #ff8800;
    }

    .controls {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .hidden {
        display: none;
    }
</style>
{% endblock css %}

{% block content %}
<div class="upload-container">
    <div class="upload-header">
        <h1>üì∏ Bulk Photo Upload</h1>
        <p>Upload multiple photos at once. Files are processed individually in the background.</p>
    </div>

    <div class="upload-settings">
        <div class="setting-group">
            <label for="album-select">Album (Optional):</label>
            <select id="album-select">
                <option value="">-- No Album (Add Later) --</option>
                {% for album in albums %}
                <option value="{{ album.id }}">{{ album.title }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="setting-group">
            <label>
                <input type="checkbox" id="skip-duplicates" checked>
                Skip duplicate detection (faster, but may create duplicates)
            </label>
        </div>

        <div class="setting-group">
            <label>
                <input type="checkbox" id="concurrent-uploads" checked>
                Upload 3 files simultaneously (faster, but uses more bandwidth)
            </label>
        </div>
    </div>

    <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-icon">üìÅ</div>
        <div class="drop-zone-text">Drag & Drop Photos Here</div>
        <div class="drop-zone-subtext">or click to select files</div>
        <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
    </div>

    <div class="upload-progress hidden" id="upload-progress">
        <div class="overall-progress">
            <div class="overall-progress-bar">
                <div class="overall-progress-fill" id="overall-progress-fill" style="width: 0%">
                    <span id="overall-progress-text">0%</span>
                </div>
            </div>
            <div class="overall-stats">
                <span id="stats-completed">0 of 0 completed</span>
                <span id="stats-success">‚úì 0 success</span>
                <span id="stats-duplicates">‚ö† 0 duplicates</span>
                <span id="stats-errors">‚úó 0 errors</span>
            </div>
        </div>

        <div class="file-list" id="file-list"></div>

        <div class="controls">
            <button class="btn btn-primary" id="start-upload">Start Upload</button>
            <button class="btn btn-danger hidden" id="pause-upload">Pause</button>
            <button class="btn btn-primary hidden" id="resume-upload">Resume</button>
            <button class="btn btn-secondary" id="clear-completed">Clear Completed</button>
            <button class="btn btn-secondary" id="add-more">Add More Files</button>
        </div>
    </div>
</div>

<script>
(function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadProgress = document.getElementById('upload-progress');
    const fileList = document.getElementById('file-list');
    const startBtn = document.getElementById('start-upload');
    const pauseBtn = document.getElementById('pause-upload');
    const resumeBtn = document.getElementById('resume-upload');
    const clearBtn = document.getElementById('clear-completed');
    const addMoreBtn = document.getElementById('add-more');
    const albumSelect = document.getElementById('album-select');
    const skipDuplicates = document.getElementById('skip-duplicates');
    const concurrentUploads = document.getElementById('concurrent-uploads');

    let files = [];
    let uploadQueue = [];
    let uploading = false;
    let paused = false;
    let activeUploads = 0;
    const maxConcurrentUploads = 3;

    let stats = {
        total: 0,
        completed: 0,
        success: 0,
        duplicates: 0,
        errors: 0
    };

    // Drag & drop handlers
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    addMoreBtn.addEventListener('click', () => fileInput.click());

    function handleFiles(fileList) {
        const newFiles = Array.from(fileList).filter(file =>
            file.type.startsWith('image/')
        );

        if (newFiles.length === 0) {
            alert('Please select image files only.');
            return;
        }

        newFiles.forEach(file => {
            const fileId = `file-${Date.now()}-${Math.random()}`;
            files.push({
                id: fileId,
                file: file,
                status: 'pending',
                progress: 0,
                photoId: null,
                error: null
            });
            addFileToList(fileId, file);
        });

        stats.total = files.length;
        updateStats();
        uploadProgress.classList.remove('hidden');
        fileInput.value = '';
    }

    function addFileToList(fileId, file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.id = fileId;
        fileItem.innerHTML = `
            <div class="file-icon">üì∑</div>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
            <div class="file-progress">
                <div class="file-progress-bar">
                    <div class="file-progress-fill" style="width: 0%"></div>
                </div>
                <div class="file-status">Waiting...</div>
            </div>
        `;
        fileList.appendChild(fileItem);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    startBtn.addEventListener('click', startUpload);
    pauseBtn.addEventListener('click', pauseUpload);
    resumeBtn.addEventListener('click', resumeUpload);
    clearBtn.addEventListener('click', clearCompleted);

    function startUpload() {
        if (files.length === 0) return;

        uploading = true;
        paused = false;
        startBtn.classList.add('hidden');
        pauseBtn.classList.remove('hidden');

        uploadQueue = files.filter(f => f.status === 'pending');
        processQueue();
    }

    function pauseUpload() {
        paused = true;
        pauseBtn.classList.add('hidden');
        resumeBtn.classList.remove('hidden');
    }

    function resumeUpload() {
        paused = false;
        pauseBtn.classList.remove('hidden');
        resumeBtn.classList.add('hidden');
        processQueue();
    }

    function processQueue() {
        if (paused || !uploading) return;

        const maxUploads = concurrentUploads.checked ? maxConcurrentUploads : 1;

        while (activeUploads < maxUploads && uploadQueue.length > 0) {
            const fileData = uploadQueue.shift();
            uploadFile(fileData);
        }

        if (activeUploads === 0 && uploadQueue.length === 0) {
            finishUpload();
        }
    }

    async function uploadFile(fileData) {
        activeUploads++;
        updateFileStatus(fileData.id, 'Uploading...', 0);

        const formData = new FormData();
        formData.append('photo', fileData.file);
        formData.append('skip_duplicates', skipDuplicates.checked);
        if (albumSelect.value) {
            formData.append('album_id', albumSelect.value);
        }

        try {
            const response = await fetch('{% url "photos:upload_photo_api" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (response.ok) {
                fileData.status = 'success';
                fileData.photoId = data.photo_id;
                stats.success++;
                updateFileStatus(fileData.id, '‚úì Uploaded successfully', 100, 'success');
            } else if (response.status === 409 && data.error === 'duplicate') {
                fileData.status = 'duplicate';
                stats.duplicates++;
                updateFileStatus(fileData.id, '‚ö† Duplicate - skipped', 100, 'duplicate');
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (error) {
            fileData.status = 'error';
            fileData.error = error.message;
            stats.errors++;
            updateFileStatus(fileData.id, `‚úó Error: ${error.message}`, 0, 'error');
        }

        stats.completed++;
        activeUploads--;
        updateStats();
        processQueue();
    }

    function updateFileStatus(fileId, status, progress, className = '') {
        const fileItem = document.getElementById(fileId);
        if (!fileItem) return;

        const progressFill = fileItem.querySelector('.file-progress-fill');
        const statusText = fileItem.querySelector('.file-status');

        progressFill.style.width = progress + '%';
        statusText.textContent = status;

        if (className) {
            progressFill.className = `file-progress-fill ${className}`;
            statusText.className = `file-status ${className}`;
        }
    }

    function updateStats() {
        const percentage = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;

        document.getElementById('overall-progress-fill').style.width = percentage + '%';
        document.getElementById('overall-progress-text').textContent = percentage + '%';
        document.getElementById('stats-completed').textContent = `${stats.completed} of ${stats.total} completed`;
        document.getElementById('stats-success').textContent = `‚úì ${stats.success} success`;
        document.getElementById('stats-duplicates').textContent = `‚ö† ${stats.duplicates} duplicates`;
        document.getElementById('stats-errors').textContent = `‚úó ${stats.errors} errors`;
    }

    function finishUpload() {
        uploading = false;
        pauseBtn.classList.add('hidden');
        resumeBtn.classList.add('hidden');
        startBtn.classList.remove('hidden');
        startBtn.textContent = 'Upload More';

        alert(`Upload complete!\n‚úì ${stats.success} successful\n‚ö† ${stats.duplicates} duplicates\n‚úó ${stats.errors} errors`);
    }

    function clearCompleted() {
        files = files.filter(f => f.status === 'pending');

        document.querySelectorAll('.file-item').forEach(item => {
            const fileId = item.id;
            const fileData = files.find(f => f.id === fileId);
            if (!fileData) {
                item.remove();
            }
        });

        stats.total = files.length;
        stats.completed = 0;
        stats.success = 0;
        stats.duplicates = 0;
        stats.errors = 0;
        updateStats();

        if (files.length === 0) {
            uploadProgress.classList.add('hidden');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
})();
</script>
{% endblock content %}
