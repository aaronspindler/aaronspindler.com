{% extends '_base.html' %}
{% load static %}
{% load photo_tags %}

{% block title %}{{ album.title }} - Photo Album{% endblock title %}

{% block css %}
{{ block.super }}
<style>
    .album-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ddd;
    }

    .album-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1ch;
        margin: 0;
    }

    .album-title {
        margin: 0;
        margin-bottom: 10px;
    }

    .album-description {
        color: #666;
        margin: 0;
    }

    .album-meta {
        color: #999;
        font-size: 0.9em;
        margin-top: 10px;
    }

    .download-all-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5ch;
        padding: calc(var(--line-height) / 2 - var(--border-thickness)) calc(1ch - var(--border-thickness));
        border: var(--border-thickness) solid var(--text-color);
        background: var(--background-color);
        color: var(--text-color);
        font: inherit;
        font-size: 0.8rem;
        font-weight: var(--font-weight-medium);
        text-transform: uppercase;
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        margin: 0;
        height: auto;
        line-height: var(--line-height);
    }

    .download-all-button:hover {
        background: var(--background-color-alt);
    }

    .download-all-button:active {
        transform: translate(1px, 1px);
    }

    .download-all-button svg {
        width: 1em;
        height: 1em;
        flex-shrink: 0;
    }

    .download-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        border: none;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.75em;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, background 0.3s, transform 0.2s;
        backdrop-filter: blur(10px);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .photo-item:hover .download-button {
        opacity: 1;
    }

    .download-button:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.05);
    }

    .photos-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: 200px;
        grid-auto-flow: dense;
        gap: 8px;
        margin-top: 30px;
        align-items: stretch;
    }

    @media (max-width: 1200px) {
        .photos-grid {
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 180px;
        }
    }

    @media (max-width: 768px) {
        .photos-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 150px;
        }
    }

    @media (max-width: 480px) {
        .photos-grid {
            grid-template-columns: 1fr;
            grid-auto-rows: auto;
        }
    }

    .photo-item {
        position: relative;
        overflow: hidden;
        border-radius: 4px;
        background: #f0f0f0;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        background-image: linear-gradient(90deg, #f0f0f0 0%, #f8f8f8 50%, #f0f0f0 100%);
        background-size: 200% 100%;
        margin-top: 0 !important;
    }

    .photo-item.featured {
        grid-column: span 2;
        grid-row: span 2;
    }

    @media (max-width: 480px) {
        .photo-item.featured {
            grid-column: span 1;
            grid-row: span 1;
        }
    }


    .photo-item.loading {
        animation: shimmer 1.5s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .photo-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .photo-item img,
    .photo-grid-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.3s;
    }

    .photo-item:hover img,
    .photo-item:hover .photo-grid-image {
        transform: scale(1.03);
    }

    .photo-title {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.4) 40%, transparent 100%);
        color: white;
        padding: 15px 12px 12px;
        font-size: 0.85em;
        opacity: 0;
        transition: opacity 0.3s;
        font-weight: 500;
    }

    .photo-item:hover .photo-title {
        opacity: 1;
    }

    .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #666;
        text-decoration: none;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        cursor: pointer;
    }

    .lightbox-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90%;
        max-height: 90%;
    }

    .lightbox-content img {
        max-width: 100%;
        max-height: 90vh;
        display: block;
        transition: opacity 0.3s ease;
    }

    .lightbox-caption {
        color: white;
        text-align: center;
        padding: 10px;
        font-size: 0.9em;
    }

    .lightbox-exif {
        position: absolute;
        bottom: 60px;
        left: 20px;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.8em;
        backdrop-filter: blur(10px);
        max-width: 400px;
    }

    .exif-row {
        display: flex;
        gap: 15px;
        margin-bottom: 4px;
    }

    .exif-row:last-child {
        margin-bottom: 0;
    }

    .exif-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .exif-label {
        opacity: 0.7;
        font-size: 0.9em;
    }

    .exif-value {
        font-weight: 500;
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 40px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
    }

    .lightbox-close:hover {
        color: #ddd;
    }

    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        padding: 10px;
        user-select: none;
    }

    .lightbox-nav:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .lightbox-prev {
        left: 20px;
    }

    .lightbox-next {
        right: 20px;
    }

    .lightbox-download {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: 1px solid white;
        border-radius: 4px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
    }

    .lightbox-download:hover {
        background: rgba(0, 0, 0, 0.9);
    }
</style>
{% endblock css %}

{% block extra_js %}
<script>
    let currentPhotoIndex = 0;
    const photos = [
        {% for photo in photos %}
        {
            id: {{ photo.id }},
            url: "{{ photo.image_gallery_cropped|safe_image_url|default:photo.image.url }}",
            thumbnailUrl: "{{ photo.image_gallery_cropped|safe_image_url|default:photo.image.url }}",
            largeUrl: "{{ photo.image_optimized|safe_image_url|default:photo.image.url }}",
            title: "{{ photo.title|escapejs }}",
            description: "{{ photo.description|escapejs }}",
            originalFilename: "{{ photo.original_filename|escapejs|default:'photo.jpg' }}",
            exif: {
                camera: "{{ photo.camera_make|escapejs }} {{ photo.camera_model|escapejs }}".trim(),
                lens: "{{ photo.lens_model|escapejs }}",
                focalLength: "{{ photo.focal_length|escapejs }}",
                aperture: "{{ photo.aperture|escapejs }}",
                shutterSpeed: "{{ photo.shutter_speed|escapejs }}",
                iso: "{{ photo.iso|default:'' }}",
                dateTaken: "{{ photo.date_taken|date:'F j, Y g:i A'|default:'' }}"
            },
            loaded: false,
            preloaded: false
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const albumSlug = "{{ album.slug }}";
    const shareToken = "{{ share_token|default:'' }}";
    const tokenParam = shareToken ? `?token=${shareToken}` : '';

    // Preload cache for lightbox images
    const imageCache = new Map();

    // Intersection Observer for lazy loading
    let imageObserver;

    function initializeLazyLoading() {
        const images = document.querySelectorAll('.photo-grid-image');

        if ('IntersectionObserver' in window) {
            imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const photoItem = img.closest('.photo-item');

                        // Load the image
                        loadImage(img, photoItem);

                        // Start preloading nearby images
                        const index = parseInt(img.dataset.index);
                        preloadNearbyImages(index);

                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            images.forEach((img, index) => {
                img.dataset.index = index;
                imageObserver.observe(img);
            });
        } else {
            // Fallback for browsers without IntersectionObserver
            images.forEach(img => loadImage(img, img.closest('.photo-item')));
        }
    }

    function loadImage(img, photoItem) {
        if (photoItem) {
            photoItem.classList.add('loading');
        }

        // Already loaded by responsive_image tag, just handle the load event
        if (img.complete) {
            if (photoItem) {
                photoItem.classList.remove('loading');
            }
        } else {
            img.onload = () => {
                if (photoItem) {
                    photoItem.classList.remove('loading');
                }
            };
        }
    }

    function preloadNearbyImages(currentIndex) {
        // Preload next 2 and previous 1 images for lightbox
        const indicesToPreload = [
            currentIndex - 1,
            currentIndex + 1,
            currentIndex + 2
        ];

        indicesToPreload.forEach(index => {
            if (index >= 0 && index < photos.length && !photos[index].preloaded) {
                preloadLightboxImage(index);
            }
        });
    }

    function preloadLightboxImage(index) {
        const photo = photos[index];
        if (!photo.preloaded && photo.largeUrl) {
            const img = new Image();
            img.onload = () => {
                photo.preloaded = true;
                imageCache.set(photo.largeUrl, img);
            };
            img.src = photo.largeUrl;
        }
    }

    function formatExifData(exif) {
        let html = '<div class="lightbox-exif">';

        // Camera row
        if (exif.camera || exif.lens) {
            html += '<div class="exif-row">';
            if (exif.camera) {
                html += `<div class="exif-item">üì∑ <span class="exif-value">${exif.camera}</span></div>`;
            }
            if (exif.lens) {
                html += `<div class="exif-item">üîç <span class="exif-value">${exif.lens}</span></div>`;
            }
            html += '</div>';
        }

        // Settings row
        const settings = [];
        if (exif.focalLength) settings.push(exif.focalLength);
        if (exif.aperture) settings.push(exif.aperture);
        if (exif.shutterSpeed) settings.push(exif.shutterSpeed);
        if (exif.iso) settings.push(`ISO ${exif.iso}`);

        if (settings.length > 0) {
            html += '<div class="exif-row">';
            html += `<div class="exif-item"><span class="exif-value">${settings.join(' ¬∑ ')}</span></div>`;
            html += '</div>';
        }

        // Date row
        if (exif.dateTaken) {
            html += '<div class="exif-row">';
            html += `<div class="exif-item">üìÖ <span class="exif-value">${exif.dateTaken}</span></div>`;
            html += '</div>';
        }

        html += '</div>';

        // Only return if we have some data
        if (exif.camera || exif.lens || settings.length > 0 || exif.dateTaken) {
            return html;
        }
        return '';
    }

    function openLightbox(index) {
        currentPhotoIndex = index;
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        const caption = document.getElementById('lightbox-caption');
        const exifContainer = document.getElementById('lightbox-exif-container');

        // Use cached image if available
        const photo = photos[index];
        const cachedImage = imageCache.get(photo.largeUrl);

        if (cachedImage) {
            img.src = cachedImage.src;
        } else {
            // Show loading state
            img.style.opacity = '0.5';
            img.src = photo.thumbnailUrl || photo.url; // Show thumbnail immediately

            // Load full resolution
            const tempImg = new Image();
            tempImg.onload = () => {
                img.src = tempImg.src;
                img.style.opacity = '1';
                imageCache.set(photo.largeUrl, tempImg);
                photo.preloaded = true;
            };
            tempImg.src = photo.largeUrl;
        }

        caption.textContent = photo.title || '';

        // Display EXIF data
        if (exifContainer) {
            exifContainer.innerHTML = formatExifData(photo.exif);
        }

        // Preload adjacent images
        preloadAdjacentLightboxImages(index);

        lightbox.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function preloadAdjacentLightboxImages(currentIndex) {
        // Preload previous and next images
        const indices = [currentIndex - 1, currentIndex + 1];

        indices.forEach(index => {
            if (index >= 0 && index < photos.length) {
                preloadLightboxImage(index);
            }
        });
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function navigatePhoto(direction) {
        currentPhotoIndex += direction;

        if (currentPhotoIndex < 0) {
            currentPhotoIndex = photos.length - 1;
        } else if (currentPhotoIndex >= photos.length) {
            currentPhotoIndex = 0;
        }

        const img = document.getElementById('lightbox-img');
        const caption = document.getElementById('lightbox-caption');
        const exifContainer = document.getElementById('lightbox-exif-container');

        img.src = photos[currentPhotoIndex].largeUrl || photos[currentPhotoIndex].url;
        caption.textContent = photos[currentPhotoIndex].title || '';

        // Update EXIF data
        if (exifContainer) {
            exifContainer.innerHTML = formatExifData(photos[currentPhotoIndex].exif);
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        const lightbox = document.getElementById('lightbox');
        if (lightbox.style.display === 'block') {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigatePhoto(-1);
            } else if (e.key === 'ArrowRight') {
                navigatePhoto(1);
            }
        }
    });

    // Download photo function using server endpoint
    function downloadPhoto(photoId) {
        window.location.href = `/photos/album/${albumSlug}/photo/${photoId}/download/${tokenParam}`;
    }

    // Download current photo in lightbox
    function downloadCurrentPhoto() {
        if (currentPhotoIndex >= 0 && currentPhotoIndex < photos.length) {
            const photo = photos[currentPhotoIndex];
            downloadPhoto(photo.id);
        }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeLazyLoading();

        // Preload first few images
        for (let i = 0; i < Math.min(3, photos.length); i++) {
            preloadLightboxImage(i);
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (imageObserver) {
            imageObserver.disconnect();
        }
    });
</script>
{% endblock extra_js %}

{% block content %}
<main class="content" role="main">
    <a href="/#photos" class="back-link">‚Üê Back to homepage</a>

    <div class="album-header">
        <div class="album-header-top">
            <h1 class="album-title">{{ album.title }}</h1>
            {% if allow_downloads and album.zip_file and album.zip_generation_status == "ready" %}
                <a href="{% url 'photos:download_album_zip' album.slug %}{% if share_token %}?token={{ share_token }}{% endif %}" class="download-all-button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download All
                </a>
            {% endif %}
        </div>
        {% if album.description %}
            <p class="album-description">{{ album.description }}</p>
        {% endif %}
        <div class="album-meta">
            {{ photos|length }} photo{{ photos|length|pluralize }} ¬∑
            Created {{ album.created_at|date:"F j, Y" }}
        </div>
    </div>

    {% if photos_data %}
        <div class="photos-grid">
            {% for item in photos_data %}
                <div class="photo-item{% if item.is_featured %} featured{% endif %} loading" onclick="openLightbox({{ forloop.counter0 }})" data-photo-index="{{ forloop.counter0 }}">
                    {% responsive_image item.photo css_class="photo-grid-image" alt_text=item.photo.title|default:item.photo.original_filename loading="lazy" %}
                    {% if item.photo.title %}
                        <div class="photo-title">{{ item.photo.title }}</div>
                    {% endif %}
                    {% if allow_downloads %}
                        <button class="download-button" onclick="event.stopPropagation(); downloadPhoto({{ item.photo.id }})" title="Download photo">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Download</span>
                        </button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No photos in this album yet.</p>
    {% endif %}

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <span class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); navigatePhoto(-1)">&#10094;</span>
        <span class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); navigatePhoto(1)">&#10095;</span>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="">
            <div id="lightbox-caption" class="lightbox-caption"></div>
        </div>
        <div id="lightbox-exif-container" onclick="event.stopPropagation()"></div>
        {% if allow_downloads %}
            <button class="lightbox-download" onclick="event.stopPropagation(); downloadCurrentPhoto()">
                ‚¨á Download Full Resolution
            </button>
        {% endif %}
    </div>
</main>
{% endblock content %}
