{% extends '_base.html' %}
{% load static %}
{% load photo_tags %}

{% block title %}{{ album.title }} - Photo Album{% endblock title %}


{% block extra_js %}
<script>
    let currentPhotoIndex = 0;
    const photos = [
        {% for item in photos_data %}
        {
            id: {{ item.photo.id }},
            url: "{{ item.photo.image_thumbnail|safe_image_url|default:item.photo.image.url }}",
            thumbnailUrl: "{{ item.photo.image_thumbnail|safe_image_url|default:item.photo.image.url }}",
            largeUrl: "{{ item.photo.image_preview|safe_image_url|default:item.photo.image.url }}",
            title: "{{ item.photo.title|escapejs }}",
            originalFilename: "{{ item.photo.original_filename|escapejs|default:'photo.jpg' }}",
            exif: null,
            exifLoaded: false,
            loaded: false,
            preloaded: false
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const albumSlug = "{{ album.slug }}";
    const shareToken = "{{ share_token|default:'' }}";
    const tokenParam = shareToken ? `?token=${shareToken}` : '';

    async function fetchExifData(photoIndex) {
        const photo = photos[photoIndex];
        if (photo.exifLoaded) return photo.exif;

        try {
            const response = await fetch(`/photos/album/${albumSlug}/photo/${photo.id}/exif/${tokenParam}`);
            if (response.ok) {
                const data = await response.json();
                photo.exif = data.exif;
                photo.exifLoaded = true;
                return photo.exif;
            }
        } catch (error) {
            console.error('Failed to load EXIF data:', error);
        }
        photo.exifLoaded = true;
        photo.exif = {};
        return photo.exif;
    }

    function updateExifDisplay(exif) {
        const exifContainer = document.getElementById('lightbox-exif-container');
        if (exifContainer) {
            exifContainer.innerHTML = formatExifData(exif || {});
        }
    }

    // Preload cache for lightbox images
    const imageCache = new Map();

    // Intersection Observer for lazy loading
    let imageObserver;

    function initializeLazyLoading() {
        const images = document.querySelectorAll('.photo-grid-image');

        if ('IntersectionObserver' in window) {
            imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const photoItem = img.closest('.photo-item');

                        // Load the image
                        loadImage(img, photoItem);

                        // Start preloading nearby images
                        const index = parseInt(img.dataset.index);
                        preloadNearbyImages(index);

                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.01
            });

            images.forEach((img, index) => {
                img.dataset.index = index;
                imageObserver.observe(img);
            });
        } else {
            // Fallback for browsers without IntersectionObserver
            images.forEach(img => loadImage(img, img.closest('.photo-item')));
        }
    }

    function loadImage(img, photoItem) {
        if (photoItem) {
            photoItem.classList.add('loading');
        }

        // Already loaded by responsive_image tag, just handle the load event
        if (img.complete) {
            if (photoItem) {
                photoItem.classList.remove('loading');
            }
        } else {
            img.onload = () => {
                if (photoItem) {
                    photoItem.classList.remove('loading');
                }
            };
        }
    }

    function preloadNearbyImages(currentIndex) {
        // Preload next 2 and previous 1 images for lightbox
        const indicesToPreload = [
            currentIndex - 1,
            currentIndex + 1,
            currentIndex + 2
        ];

        indicesToPreload.forEach(index => {
            if (index >= 0 && index < photos.length && !photos[index].preloaded) {
                preloadLightboxImage(index);
            }
        });
    }

    function preloadLightboxImage(index) {
        const photo = photos[index];
        if (!photo.preloaded && photo.largeUrl) {
            const img = new Image();
            img.onload = () => {
                photo.preloaded = true;
                imageCache.set(photo.largeUrl, img);
            };
            img.src = photo.largeUrl;
        }
    }

    function formatExifData(exif) {
        let html = '<div class="lightbox-exif">';

        // Camera row
        if (exif.camera || exif.lens) {
            html += '<div class="exif-row">';
            if (exif.camera) {
                html += `<div class="exif-item">üì∑ <span class="exif-value">${exif.camera}</span></div>`;
            }
            if (exif.lens) {
                html += `<div class="exif-item">üîç <span class="exif-value">${exif.lens}</span></div>`;
            }
            html += '</div>';
        }

        // Settings row
        const settings = [];
        if (exif.focalLength) settings.push(exif.focalLength);
        if (exif.aperture) settings.push(exif.aperture);
        if (exif.shutterSpeed) settings.push(exif.shutterSpeed);
        if (exif.iso) settings.push(`ISO ${exif.iso}`);

        if (settings.length > 0) {
            html += '<div class="exif-row">';
            html += `<div class="exif-item"><span class="exif-value">${settings.join(' ¬∑ ')}</span></div>`;
            html += '</div>';
        }

        // Date row
        if (exif.dateTaken) {
            html += '<div class="exif-row">';
            html += `<div class="exif-item">üìÖ <span class="exif-value">${exif.dateTaken}</span></div>`;
            html += '</div>';
        }

        html += '</div>';

        // Only return if we have some data
        if (exif.camera || exif.lens || settings.length > 0 || exif.dateTaken) {
            return html;
        }
        return '';
    }

    async function openLightbox(index) {
        currentPhotoIndex = index;
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        const caption = document.getElementById('lightbox-caption');

        // Use cached image if available
        const photo = photos[index];
        const cachedImage = imageCache.get(photo.largeUrl);

        if (cachedImage) {
            img.src = cachedImage.src;
        } else {
            // Show loading state
            img.style.opacity = '0.5';
            img.src = photo.thumbnailUrl || photo.url; // Show thumbnail immediately

            // Load full resolution
            const tempImg = new Image();
            tempImg.onload = () => {
                img.src = tempImg.src;
                img.style.opacity = '1';
                imageCache.set(photo.largeUrl, tempImg);
                photo.preloaded = true;
            };
            tempImg.src = photo.largeUrl;
        }

        caption.textContent = photo.title || '';

        // Fetch and display EXIF data asynchronously
        updateExifDisplay(photo.exif);
        if (!photo.exifLoaded) {
            const exif = await fetchExifData(index);
            if (currentPhotoIndex === index) {
                updateExifDisplay(exif);
            }
        }

        // Preload adjacent images
        preloadAdjacentLightboxImages(index);

        lightbox.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function preloadAdjacentLightboxImages(currentIndex) {
        // Preload previous and next images
        const indices = [currentIndex - 1, currentIndex + 1];

        indices.forEach(index => {
            if (index >= 0 && index < photos.length) {
                preloadLightboxImage(index);
            }
        });
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    async function navigatePhoto(direction) {
        currentPhotoIndex += direction;

        if (currentPhotoIndex < 0) {
            currentPhotoIndex = photos.length - 1;
        } else if (currentPhotoIndex >= photos.length) {
            currentPhotoIndex = 0;
        }

        const img = document.getElementById('lightbox-img');
        const caption = document.getElementById('lightbox-caption');
        const photo = photos[currentPhotoIndex];
        const navigatedIndex = currentPhotoIndex;

        img.src = photo.largeUrl || photo.url;
        caption.textContent = photo.title || '';

        // Fetch and display EXIF data asynchronously
        updateExifDisplay(photo.exif);
        if (!photo.exifLoaded) {
            const exif = await fetchExifData(navigatedIndex);
            if (currentPhotoIndex === navigatedIndex) {
                updateExifDisplay(exif);
            }
        }
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        const lightbox = document.getElementById('lightbox');
        if (lightbox.style.display === 'block') {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigatePhoto(-1);
            } else if (e.key === 'ArrowRight') {
                navigatePhoto(1);
            }
        }
    });

    // Touch swipe navigation for lightbox
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isSwiping = false;
    let isMultiTouch = false;
    const SWIPE_THRESHOLD = 50;
    const SWIPE_VELOCITY_THRESHOLD = 0.3;
    let touchStartTime = 0;

    function initTouchHandlers() {
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.querySelector('.lightbox-content');

        lightbox.addEventListener('touchstart', handleTouchStart, { passive: true });
        lightbox.addEventListener('touchmove', handleTouchMove, { passive: false });
        lightbox.addEventListener('touchend', handleTouchEnd, { passive: true });
        lightbox.addEventListener('touchcancel', handleTouchCancel, { passive: true });
    }

    function handleTouchStart(e) {
        if (e.touches.length > 1) {
            isMultiTouch = true;
            resetSwipeState();
            return;
        }

        isMultiTouch = false;
        isSwiping = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();

        const lightboxContent = document.querySelector('.lightbox-content');
        if (lightboxContent) {
            lightboxContent.style.transition = 'none';
        }
    }

    function handleTouchMove(e) {
        if (!isSwiping || isMultiTouch) return;

        if (e.touches.length > 1) {
            isMultiTouch = true;
            resetSwipeState();
            return;
        }

        touchEndX = e.touches[0].clientX;
        touchEndY = e.touches[0].clientY;

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // If vertical movement dominates, allow default behavior (scrolling)
        if (Math.abs(deltaY) > Math.abs(deltaX) * 1.5) {
            return;
        }

        // Prevent default to stop horizontal scrolling
        if (Math.abs(deltaX) > 10) {
            e.preventDefault();
        }

        // Visual feedback: move the image with the swipe
        const lightboxContent = document.querySelector('.lightbox-content');
        if (lightboxContent && Math.abs(deltaX) > 10) {
            const maxOffset = 100;
            const offset = Math.max(-maxOffset, Math.min(maxOffset, deltaX * 0.5));
            lightboxContent.style.transform = `translate(calc(-50% + ${offset}px), -50%)`;
        }
    }

    function handleTouchEnd(e) {
        if (!isSwiping || isMultiTouch) {
            resetSwipeState();
            return;
        }

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        const touchDuration = Date.now() - touchStartTime;
        const velocity = Math.abs(deltaX) / touchDuration;

        const lightboxContent = document.querySelector('.lightbox-content');
        if (lightboxContent) {
            lightboxContent.style.transition = 'transform 0.3s ease-out';
            lightboxContent.style.transform = 'translate(-50%, -50%)';
        }

        // Only process horizontal swipes
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
            const isQuickSwipe = velocity > SWIPE_VELOCITY_THRESHOLD;
            const isLongSwipe = Math.abs(deltaX) > SWIPE_THRESHOLD;

            if (isQuickSwipe || isLongSwipe) {
                if (deltaX > 0) {
                    navigatePhoto(-1);  // Swipe right ‚Üí previous photo
                } else {
                    navigatePhoto(1);   // Swipe left ‚Üí next photo
                }
            }
        }
        // Swipe down to close (optional feature)
        else if (deltaY > SWIPE_THRESHOLD * 2 && Math.abs(deltaY) > Math.abs(deltaX) * 2) {
            closeLightbox();
        }

        resetSwipeState();
    }

    function handleTouchCancel() {
        const lightboxContent = document.querySelector('.lightbox-content');
        if (lightboxContent) {
            lightboxContent.style.transition = 'transform 0.3s ease-out';
            lightboxContent.style.transform = 'translate(-50%, -50%)';
        }
        resetSwipeState();
    }

    function resetSwipeState() {
        isSwiping = false;
        touchStartX = 0;
        touchStartY = 0;
        touchEndX = 0;
        touchEndY = 0;
    }

    // Download photo function using server endpoint
    function downloadPhoto(photoId) {
        window.location.href = `/photos/album/${albumSlug}/photo/${photoId}/download/${tokenParam}`;
    }

    // Download current photo in lightbox
    function downloadCurrentPhoto() {
        if (currentPhotoIndex >= 0 && currentPhotoIndex < photos.length) {
            const photo = photos[currentPhotoIndex];
            downloadPhoto(photo.id);
        }
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        initializeLazyLoading();
        initTouchHandlers();

        // Preload first few images
        for (let i = 0; i < Math.min(3, photos.length); i++) {
            preloadLightboxImage(i);
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        if (imageObserver) {
            imageObserver.disconnect();
        }
    });
</script>
{% endblock extra_js %}

{% block content %}
<main class="content" role="main">
    <a href="/#photos" class="back-link">‚Üê Back to homepage</a>

    <div class="album-header">
        <div class="album-header-top">
            <h1 class="album-title">{{ album.title }}</h1>
            {% if allow_downloads and album.zip_file and album.zip_generation_status == "ready" %}
                <a href="{% url 'photos:download_album_zip' album.slug %}{% if share_token %}?token={{ share_token }}{% endif %}" class="download-all-button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download All
                </a>
            {% endif %}
        </div>
        {% if album.description %}
            <p class="album-description">{{ album.description }}</p>
        {% endif %}
        <div class="album-meta">
            {{ photos_data|length }} photo{{ photos_data|length|pluralize }} ¬∑
            Created {{ album.created_at|date:"F j, Y" }}
        </div>
    </div>

    {% if photos_data %}
        <div class="photos-grid">
            {% for item in photos_data %}
                <div class="photo-item{% if item.is_featured %} featured{% endif %} loading" onclick="openLightbox({{ forloop.counter0 }})" data-photo-index="{{ forloop.counter0 }}">
                    {% if forloop.counter <= 4 %}
                        {% responsive_image item.photo css_class="photo-grid-image" alt_text=item.photo.title|default:item.photo.original_filename loading="eager" fetchpriority="high" %}
                    {% else %}
                        {% responsive_image item.photo css_class="photo-grid-image" alt_text=item.photo.title|default:item.photo.original_filename loading="lazy" %}
                    {% endif %}
                    {% if item.photo.title %}
                        <div class="photo-title">{{ item.photo.title }}</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No photos in this album yet.</p>
    {% endif %}

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <span class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); navigatePhoto(-1)">&#10094;</span>
        <span class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); navigatePhoto(1)">&#10095;</span>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="">
            <div id="lightbox-caption" class="lightbox-caption"></div>
        </div>
        <div id="lightbox-exif-container" onclick="event.stopPropagation()"></div>
        {% if allow_downloads %}
            <button class="lightbox-download" onclick="event.stopPropagation(); downloadCurrentPhoto()">
                ‚¨á Download Full Resolution
            </button>
        {% endif %}
    </div>
</main>
{% endblock content %}
