# QuestDB Configuration for CapRover Deployment
# Optimized for FeeFiFoFunds high-volume time-series ingestion
#
# CapRover Setup:
# - Persistent Directory: /root/.questdb (Label: aaronspindler-questdb-data)
# - PG Credentials: Set via environment variables (QDB_PG_USER, QDB_PG_PASSWORD)

# Strict config validation
config.validation.strict=true

################ Resource Management ##################

# RAM limit (75% for container environments)
# Adjust if your container has specific memory limits
ram.usage.limit.percent=75

# Worker thread pools - ADJUST THIS based on container CPU allocation
# Recommended: Set to CPU count or CPU count - 1
shared.worker.count=4

################ HTTP Server ##################

http.enabled=true
http.net.bind.to=0.0.0.0:9000
http.net.connection.limit=512
http.net.connection.timeout=5m
http.net.connection.queue.timeout=5000
http.net.connection.sndbuf=2m
http.net.connection.rcvbuf=2m
http.send.buffer.size=2m

# HTTP connection type limits
http.json.query.connection.limit=-1
http.export.connection.limit=-1

# HTTP protocol settings
http.version=HTTP/1.1
http.server.keep.alive=true
http.keep-alive.timeout=5
http.keep-alive.max=10000

# Query settings
http.query.cache.enabled=true
http.query.cache.block.count=32
http.query.cache.row.count=8
query.timeout=1m

# Security
http.security.readonly=false
http.settings.readonly=false

# Static files
http.static.public.directory=public

################ HTTP Min (Health Check) ##################

http.min.enabled=true
http.min.net.bind.to=0.0.0.0:9003
http.pessimistic.health.check.enabled=false

################ Cairo (Storage Engine) ##################

cairo.root=db
cairo.commit.mode=nosync
cairo.commit.latency=30s

# Symbol settings
cairo.default.symbol.cache.flag=true
cairo.default.symbol.capacity=256
cairo.auto.scale.symbol.capacity=true
cairo.auto.scale.symbol.capacity.threshold=0.8

# Table operations
cairo.create.as.select.retry.count=5
cairo.file.operation.retry.count=30
cairo.max.file.name.length=127

# Reader/Writer pools
cairo.reader.pool.max.segments=10
cairo.inactive.reader.max.open.partitions=128
cairo.inactive.reader.ttl=2m
cairo.inactive.writer.ttl=30m

# Performance settings
cairo.parallel.indexing.enabled=true
cairo.parallel.index.threshold=100000
cairo.spin.lock.timeout=1s
cairo.idle.check.interval=5m

# Memory settings
cairo.o3.column.memory.size=8M
cairo.system.o3.column.memory.size=256k
cairo.writer.data.append.page.size=16M
cairo.writer.data.index.key.append.page.size=512k
cairo.writer.data.index.value.append.page.size=16M
cairo.system.writer.data.append.page.size=256k

# O3 (Out-of-order) settings - critical for time-series
cairo.max.uncommitted.rows=1000000
cairo.o3.min.lag=1s
cairo.o3.max.lag=600000
cairo.o3.partition.purge.list.initial.capacity=1
cairo.o3.partition.split.min.size=50M
cairo.o3.last.partition.max.splits=20

# Writer settings
cairo.writer.tick.rows.count=1024
cairo.writer.command.queue.capacity=32
cairo.writer.alter.busy.wait.timeout=500ms

# SQL execution pools
cairo.sql.small.map.key.capacity=2097152
cairo.sql.small.map.page.size=4m
cairo.sql.page.frame.min.rows=100000
cairo.sql.page.frame.max.rows=1000000

################ Parallel SQL Execution ##################

cairo.sql.parallel.filter.enabled=true
cairo.sql.parallel.groupby.enabled=true
cairo.sql.parallel.groupby.sharding.threshold=100000
cairo.sql.parallel.read.parquet.enabled=true
cairo.sql.parallel.topk.enabled=true

# JIT compilation
cairo.sql.jit.mode=on
cairo.sql.jit.ir.memory.page.size=8K
cairo.sql.jit.ir.memory.max.pages=8
cairo.sql.jit.debug.enabled=false

################ SQL Copy (Import/Export) ##################

# Relative paths (will be created under /root/.questdb/)
cairo.sql.copy.root=import
cairo.sql.copy.export.root=export
cairo.sql.copy.formats.file=/text_loader.json
cairo.sql.copy.buffer.size=2m
cairo.sql.copy.max.index.chunk.size=100M
cairo.sql.copy.queue.capacity=32
cairo.sql.copy.log.retention.days=3

# Parquet export settings
cairo.parquet.export.version=2
cairo.parquet.export.statistics.enabled=true
cairo.parquet.export.compression.codec=ZSTD
cairo.parquet.export.compression.level=9

################ LINE Protocol (ILP) ##################

# Default settings
line.default.partition.by=DAY
line.auto.create.new.columns=true
line.auto.create.new.tables=true
line.log.message.on.error=true

# LINE TCP (Primary ingestion method)
line.tcp.enabled=true
line.tcp.net.bind.to=0.0.0.0:9009
line.tcp.net.connection.limit=512
line.tcp.net.connection.timeout=0
line.tcp.net.connection.queue.timeout=5000
line.tcp.net.connection.rcvbuf=-1
line.tcp.recv.buffer.size=2048
line.tcp.max.measurement.size=2048
line.tcp.max.recv.buffer.size=1073741824

# LINE TCP worker settings
line.tcp.writer.queue.capacity=128
line.tcp.writer.worker.count=0
line.tcp.writer.worker.yield.threshold=10
line.tcp.writer.worker.sleep.threshold=10000
line.tcp.io.worker.count=0
line.tcp.disconnect.on.error=true

# LINE TCP commit settings
line.tcp.commit.interval.fraction=0.5
line.tcp.commit.interval.default=2000
line.tcp.maintenance.job.interval=5000
line.tcp.min.idle.ms.before.writer.release=500

# LINE UDP (disabled by default)
line.udp.enabled=false

# LINE HTTP
line.http.enabled=true
line.http.max.recv.buffer.size=1073741824

################ PostgreSQL Wire Protocol ##################

pg.enabled=true
pg.net.bind.to=0.0.0.0:8812
pg.net.connection.limit=128
pg.net.connection.timeout=300000
pg.net.connection.queue.timeout=5m
pg.net.connection.rcvbuf=-1
pg.net.connection.sndbuf=-1

# PG settings
pg.character.store.capacity=4096
pg.connection.pool.capacity=64
pg.recv.buffer.size=1M
pg.send.buffer.size=1M
pg.max.blob.size.on.query=512k
pg.binary.param.count.capacity=2
pg.named.statement.limit=10000
pg.pipeline.capacity=64

# PG authentication - Set via environment variables in CapRover:
# QDB_PG_USER and QDB_PG_PASSWORD
# pg.user=admin
# pg.password=quest
pg.security.readonly=false

# PG query cache
pg.select.cache.enabled=true
pg.select.cache.block.count=32
pg.select.cache.row.count=8
pg.insert.cache.enabled=true
pg.insert.cache.block.count=4
pg.insert.cache.row.count=4

################ WAL (Write-Ahead Log) ##################

cairo.wal.supported=true
cairo.wal.enabled.default=true

# WAL apply workers - ADJUST based on CPU (typically same as shared.worker.count)
wal.apply.worker.count=4

# WAL settings
cairo.wal.purge.interval=60s
cairo.wal.segment.rollover.row.count=500000
cairo.wal.segment.rollover.size=0
cairo.wal.writer.data.append.page.size=1M
cairo.wal.writer.event.append.page.size=128k
cairo.wal.writer.pool.max.segments=10

# WAL apply settings
cairo.wal.squash.uncommitted.rows.multiplier=20.0
cairo.wal.max.lag.size=75M
cairo.wal.max.lag.txn.count=-1
cairo.wal.apply.look.ahead.txn.count=20
cairo.wal.apply.table.time.quota=1s
cairo.wal.max.segment.file.descriptors.cache=30
cairo.wal.apply.parallel.sql.enabled=true

################ Materialized Views ##################

cairo.mat.view.enabled=true
cairo.mat.view.parallel.sql.enabled=true
cairo.mat.view.rows.per.query.estimate=1000000
cairo.mat.view.max.refresh.step=31536000000000us
cairo.mat.view.max.refresh.retries=10
cairo.mat.view.refresh.oom.retry.timeout=200
cairo.mat.view.insert.as.select.batch.size=1000000
cairo.mat.view.max.refresh.intervals=100
cairo.mat.view.refresh.intervals.update.period=15s

################ Telemetry & Metrics ##################

telemetry.enabled=true
telemetry.queue.capacity=512
telemetry.hide.tables=true

metrics.enabled=true

################ Logging ##################

log.timestamp.timezone=UTC
log.timestamp.locale=en
log.timestamp.format=yyyy-MM-ddTHH:mm:ss.SSSUUUz
log.sql.query.progress.exe=true

################ Advanced Settings ##################

# Circuit breaker
circuit.breaker.throttle=2000000
net.test.connection.buffer.size=64

# Date/time
cairo.date.locale=en

# IO
cairo.iouring.enabled=true
