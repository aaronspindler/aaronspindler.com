# QuestDB Optimized Configuration
# Balanced for 16GB RAM, 6-8 cores, burst ingestion (20K-50K rows/sec)
#
# This config provides a middle ground between:
# - questdb_config.properties (normal operations, slower)
# - questdb_config_bulk_ingest.properties (bulk ingestion, causes crashes)
#
# Optimized for burst performance without causing timeouts/hangs

# Strict config validation
config.validation.strict=true

################ Resource Management ##################

# RAM limit - conservative for 16GB system (leaves 4GB for OS)
ram.usage.limit.percent=75

# Worker thread pools - matched to your 6-8 core CPU
shared.worker.count=6

################ HTTP Server ##################

http.enabled=true
http.net.bind.to=0.0.0.0:9000
http.net.connection.limit=512
http.net.connection.timeout=5m
http.net.connection.queue.timeout=5000
http.net.connection.sndbuf=2m
http.net.connection.rcvbuf=2m
http.send.buffer.size=2m

# HTTP connection type limits
http.json.query.connection.limit=-1
http.export.connection.limit=-1

# HTTP protocol settings
http.version=HTTP/1.1
http.server.keep.alive=true
http.keep-alive.timeout=5
http.keep-alive.max=10000

# Query settings - enabled but with moderate cache
http.query.cache.enabled=true
http.query.cache.block.count=16
http.query.cache.row.count=4
query.timeout=2m

# Security
http.security.readonly=false
http.settings.readonly=false

# Static files
http.static.public.directory=public

################ HTTP Min (Health Check) ##################

http.min.enabled=true
http.min.net.bind.to=0.0.0.0:9003
http.pessimistic.health.check.enabled=false

################ Cairo (Storage Engine) - OPTIMIZED FOR BURSTS ##################

cairo.root=db
cairo.commit.mode=nosync
# Moderate commit latency to prevent hangs
cairo.commit.latency=45s

# Symbol settings
cairo.default.symbol.cache.flag=true
# Increased for more assets
cairo.default.symbol.capacity=384
cairo.auto.scale.symbol.capacity=true
cairo.auto.scale.symbol.capacity.threshold=0.8

# Table operations
cairo.create.as.select.retry.count=5
cairo.file.operation.retry.count=30
cairo.max.file.name.length=127

# Reader/Writer pools - balanced
cairo.reader.pool.max.segments=8
cairo.inactive.reader.max.open.partitions=96
cairo.inactive.reader.ttl=3m
cairo.inactive.writer.ttl=45m

# Performance settings
cairo.parallel.indexing.enabled=true
cairo.parallel.index.threshold=100000
cairo.spin.lock.timeout=1s
cairo.idle.check.interval=7m

# Memory settings - 2-3x increases (moderate, not aggressive)
# 3x increase from 8M
cairo.o3.column.memory.size=24M
# 2x increase from 256k
cairo.system.o3.column.memory.size=512k
# 2x increase from 16M
cairo.writer.data.append.page.size=32M
# 2x increase from 512k
cairo.writer.data.index.key.append.page.size=1M
# 2x increase from 16M
cairo.writer.data.index.value.append.page.size=32M
# 2x increase from 256k
cairo.system.writer.data.append.page.size=512k

# O3 (Out-of-order) settings - MODERATE INCREASES
# 3x increase from 1M (not 10x like bulk)
cairo.max.uncommitted.rows=3000000
# Moderate lag
cairo.o3.min.lag=3s
# 10 minutes in microseconds (between normal 600000 and bulk 3600000000)
cairo.o3.max.lag=600000000
cairo.o3.partition.purge.list.initial.capacity=5
# Moderate increase
cairo.o3.partition.split.min.size=75M
# Moderate increase
cairo.o3.last.partition.max.splits=50

# Writer settings - moderate throughput optimization
# 5x increase from 1024
cairo.writer.tick.rows.count=5120
# 2x increase from 32
cairo.writer.command.queue.capacity=64
cairo.writer.alter.busy.wait.timeout=750ms

# SQL execution pools - moderate increases
# 1.5x increase
cairo.sql.small.map.key.capacity=3145728
# 1.5x increase
cairo.sql.small.map.page.size=6m
# 3x increase
cairo.sql.page.frame.min.rows=300000
# 3x increase
cairo.sql.page.frame.max.rows=3000000

################ Parallel SQL Execution ##################

cairo.sql.parallel.filter.enabled=true
cairo.sql.parallel.groupby.enabled=true
cairo.sql.parallel.groupby.sharding.threshold=100000
cairo.sql.parallel.read.parquet.enabled=true
cairo.sql.parallel.topk.enabled=true

# JIT compilation
cairo.sql.jit.mode=on
# Moderate increase
cairo.sql.jit.ir.memory.page.size=12K
# Moderate increase
cairo.sql.jit.ir.memory.max.pages=12
cairo.sql.jit.debug.enabled=false

################ SQL Copy (Import/Export) ##################

cairo.sql.copy.root=import
cairo.sql.copy.export.root=export
cairo.sql.copy.formats.file=/text_loader.json
# 2x increase from 2m
cairo.sql.copy.buffer.size=4m
# 2x increase from 100M
cairo.sql.copy.max.index.chunk.size=200M
# 2x increase from 32
cairo.sql.copy.queue.capacity=64
cairo.sql.copy.log.retention.days=2

# Parquet export settings
cairo.parquet.export.version=2
cairo.parquet.export.statistics.enabled=true
cairo.parquet.export.compression.codec=ZSTD
# Moderate compression (between normal 9 and bulk 3)
cairo.parquet.export.compression.level=6

################ LINE Protocol (ILP) - BURST OPTIMIZED ##################

# Default settings
line.default.partition.by=DAY
line.auto.create.new.columns=true
line.auto.create.new.tables=true
line.log.message.on.error=true

# LINE TCP (Primary ingestion method) - MODERATE OPTIMIZATION
line.tcp.enabled=true
line.tcp.net.bind.to=0.0.0.0:9009
# Moderate increase
line.tcp.net.connection.limit=768
line.tcp.net.connection.timeout=0
# Moderate increase
line.tcp.net.connection.queue.timeout=7500
line.tcp.net.connection.rcvbuf=-1
# 2x increase from 2048
line.tcp.recv.buffer.size=4096
# 2x increase from 2048
line.tcp.max.measurement.size=4096
# 1.5GB (between normal 1GB and bulk 2GB)
line.tcp.max.recv.buffer.size=1610612736

# LINE TCP worker settings - moderate increases
# 2x increase from 128
line.tcp.writer.queue.capacity=256
line.tcp.writer.worker.count=0
# Moderate increase
line.tcp.writer.worker.yield.threshold=50
# Moderate increase
line.tcp.writer.worker.sleep.threshold=50000
line.tcp.io.worker.count=0
line.tcp.disconnect.on.error=true

# LINE TCP commit settings - OPTIMIZED FOR BURSTS
# Moderate increase
line.tcp.commit.interval.fraction=0.65
# 5 seconds (between normal 2s and bulk 10s)
line.tcp.commit.interval.default=5000
# 15 seconds (between normal 5s and bulk 30s)
line.tcp.maintenance.job.interval=15000
# Moderate increase
line.tcp.min.idle.ms.before.writer.release=2000

# LINE UDP (disabled)
line.udp.enabled=false

# LINE HTTP
line.http.enabled=true
# 1.5GB
line.http.max.recv.buffer.size=1610612736

################ PostgreSQL Wire Protocol ##################

pg.enabled=true
pg.net.bind.to=0.0.0.0:8812
pg.net.connection.limit=128
pg.net.connection.timeout=300000
pg.net.connection.queue.timeout=5m
pg.net.connection.rcvbuf=-1
pg.net.connection.sndbuf=-1

# PG settings
pg.character.store.capacity=4096
pg.connection.pool.capacity=64
# Moderate increase
pg.recv.buffer.size=2M
# Moderate increase
pg.send.buffer.size=2M
# Moderate increase
pg.max.blob.size.on.query=1M
pg.binary.param.count.capacity=2
pg.named.statement.limit=10000
# Moderate increase
pg.pipeline.capacity=96

# PG authentication
pg.security.readonly=false

# PG query cache - enabled with smaller sizes
pg.select.cache.enabled=true
pg.select.cache.block.count=16
pg.select.cache.row.count=4
pg.insert.cache.enabled=true
pg.insert.cache.block.count=2
pg.insert.cache.row.count=2

################ WAL (Write-Ahead Log) - BURST OPTIMIZED ##################

cairo.wal.supported=true
cairo.wal.enabled.default=true

# WAL apply workers - matched to CPU
wal.apply.worker.count=6

# WAL settings - moderate optimization
# Moderate increase
cairo.wal.purge.interval=90s
# 2M rows (between normal 500K and bulk 5M)
cairo.wal.segment.rollover.row.count=2000000
cairo.wal.segment.rollover.size=0
# 4x increase from 1M
cairo.wal.writer.data.append.page.size=4M
# 2x increase from 128k
cairo.wal.writer.event.append.page.size=256k
# Moderate increase
cairo.wal.writer.pool.max.segments=15

# WAL apply settings - burst oriented
# Moderate increase
cairo.wal.squash.uncommitted.rows.multiplier=35.0
# 200M (between normal 75M and bulk 500M)
cairo.wal.max.lag.size=200M
cairo.wal.max.lag.txn.count=-1
# Moderate increase
cairo.wal.apply.look.ahead.txn.count=50
# Moderate increase
cairo.wal.apply.table.time.quota=3s
# Moderate increase
cairo.wal.max.segment.file.descriptors.cache=60
cairo.wal.apply.parallel.sql.enabled=true

################ Materialized Views ##################

# Enabled for normal query performance
cairo.mat.view.enabled=true
cairo.mat.view.parallel.sql.enabled=true
cairo.mat.view.rows.per.query.estimate=1000000
cairo.mat.view.max.refresh.step=31536000000000us
cairo.mat.view.max.refresh.retries=10
cairo.mat.view.refresh.oom.retry.timeout=200
cairo.mat.view.insert.as.select.batch.size=1000000
cairo.mat.view.max.refresh.intervals=100
cairo.mat.view.refresh.intervals.update.period=15s

################ Telemetry & Metrics ##################

telemetry.enabled=true
telemetry.queue.capacity=512
telemetry.hide.tables=true

metrics.enabled=true

################ Logging ##################

log.timestamp.timezone=UTC
log.timestamp.locale=en
log.timestamp.format=yyyy-MM-ddTHH:mm:ss.SSSUUUz
log.sql.query.progress.exe=true

################ Advanced Settings ##################

# Circuit breaker - moderate increase
# 5x increase from 2M
circuit.breaker.throttle=10000000
# Moderate increase
net.test.connection.buffer.size=131072

# Date/time
cairo.date.locale=en

# IO
cairo.iouring.enabled=true
