{% load static %}
{% load css_version %}
<!DOCTYPE html>
<html lang="en">

<head>
  {% include '_meta.html' %}
  <title>Aaronspindler.com - {{ blog_title }}</title>

  <!-- Theme detection script - prevents FOUC -->
  <script>
    (function(){
      var stored = localStorage.getItem('theme-preference');
      var theme = stored && ['light','dark'].includes(stored) ? stored : 'auto';
      document.documentElement.className = 'theme-' + theme;
    })();
  </script>

  {% block css %}
  {% versioned_css as css_file %}
  <link rel="stylesheet" href="{% static css_file %}">
  <!-- Prism.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">
  {% endblock %}
</head>

<body>
  {% include '_header.html' %}
  <div class="back-button">
    <a href="{% url 'home' %}#blog">Back</a>
    <br>
  </div>
  <table class="blog-metadata">
    <tr>
      <td colspan="2">{{ blog_title|safe }}</td>
    </tr>
    <tr>
      <th>Times Read</th>
      <td>{{ views }}</td>
    </tr>
    <tr>
      <th>Change Log</th>
      <td><a href="{{ github_link }}">View on Github</a></td>
    </tr>
  </table>
  {{ blog_content|safe }}

  <!-- Tags Section -->
  {% if tags %}
  <div class="blog-tags-section">
    <h3>Tags</h3>
    <div class="blog-tags">
      {% for tag in tags %}
      <a href="{% url 'search' %}?tag={{ tag.slug }}" class="blog-tag" style="background-color: {{ tag.color }};">
        {{ tag.name }}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Related Posts Section -->
  {% if related_posts %}
  <div class="related-posts-section">
    <h3>Related Posts</h3>
    <div class="related-posts">
      {% for post in related_posts %}
      <article class="related-post">
        <h4>
          <a href="/b/{{ post.category }}/{{ post.template_name }}/">
            {{ post.blog_title }}
          </a>
        </h4>
        {% if post.shared_tags %}
        <div class="related-post-tags">
          {% for tag in post.shared_tags %}
          <span class="related-post-tag" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Comments Section -->
  <div id="comments" class="comments-section">
    <h2>Comments ({{ comment_count }})</h2>

    {% if pending_comments_count and user.is_staff %}
    <div class="alert alert-info">
      <strong>Staff Notice:</strong> There are {{ pending_comments_count }} pending comments for this post.
      <a href="/admin/blog/blogcomment/?blog_template_name={{ template_name }}&status__exact=pending" target="_blank">Review in Admin</a>
    </div>
    {% endif %}

    {% include '_messages.html' %}

    <!-- Comment Form -->
    <div class="comment-form-container">
      <h3>Leave a Comment</h3>
      {% if user.is_authenticated %}
        <p class="comment-author-info">Commenting as <strong>{{ user.username }}</strong></p>
      {% else %}
        <p class="comment-author-info">You can comment anonymously or <a href="{% url 'account_login' %}?next={{ request.path }}">login</a> to use your account.</p>
      {% endif %}

      <form method="post" action="{% url 'submit_comment' category=category template_name=template_name %}" class="comment-form">
        {% csrf_token %}
        {{ comment_form.website }}  <!-- Honeypot field -->

        {% if not user.is_authenticated %}
        <div class="form-group">
          {{ comment_form.author_name.label_tag }}
          {{ comment_form.author_name }}
        </div>

        <div class="form-group">
          {{ comment_form.author_email.label_tag }}
          {{ comment_form.author_email }}
          <small class="form-text">{{ comment_form.author_email.help_text }}</small>
        </div>
        {% endif %}

        <div class="form-group">
          {{ comment_form.content.label_tag }}
          {{ comment_form.content }}
          <small class="form-text">{{ comment_form.content.help_text }} <span class="char-count" id="char-count-main">0 / 2000</span></small>
          {% if comment_form.content.errors %}
          <div class="form-errors">
            {{ comment_form.content.errors }}
          </div>
          {% endif %}
        </div>

        <button type="submit" class="btn-comment-submit">Post Comment</button>
      </form>
    </div>

    <!-- Display Comments -->
    <div class="comments-list">
      {% for comment in comments %}
        {% with is_reply=False depth=0 %}
          {% include "components/comment_thread.html" %}
        {% endwith %}
      {% empty %}
      <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
      {% endfor %}
    </div>
  </div>

  <script>
  function toggleReplyForm(commentId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none') {
      form.style.display = 'block';
      // Focus on the textarea when opening
      var textarea = form.querySelector('.reply-textarea');
      if (textarea) textarea.focus();
    } else {
      form.style.display = 'none';
    }
  }

  function voteComment(commentId, voteType) {
    // Check if user is authenticated (basic check)
    {% if not user.is_authenticated %}
    alert('Please login to vote on comments.');
    window.location.href = '{% url "account_login" %}?next=' + encodeURIComponent(window.location.pathname + '#comment-' + commentId);
    return;
    {% endif %}

    // Get CSRF token
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send vote request
    fetch('/comment/' + commentId + '/vote/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: 'vote_type=' + voteType
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Update UI
        var votesContainer = document.querySelector('.comment-votes[data-comment-id="' + commentId + '"]');
        var scoreElement = document.querySelector('.vote-score[data-comment-id="' + commentId + '"]');

        if (votesContainer) {
          // Update button states
          var upvoteBtn = votesContainer.querySelector('.vote-btn.upvote');
          var downvoteBtn = votesContainer.querySelector('.vote-btn.downvote');

          // Remove active classes
          if (upvoteBtn) upvoteBtn.classList.remove('active');
          if (downvoteBtn) downvoteBtn.classList.remove('active');

          // Add active class to current vote
          if (data.user_vote === 'upvote' && upvoteBtn) {
            upvoteBtn.classList.add('active');
          } else if (data.user_vote === 'downvote' && downvoteBtn) {
            downvoteBtn.classList.add('active');
          }
        }

        // Update score in header
        if (scoreElement) {
          var scoreText = data.score > 0 ? '+' + data.score : data.score.toString();
          scoreElement.innerHTML = scoreText;

          // Update color classes
          scoreElement.classList.remove('positive', 'negative');
          if (data.score > 0) {
            scoreElement.classList.add('positive');
          } else if (data.score < 0) {
            scoreElement.classList.add('negative');
          }

          // Add a subtle animation to the score
          scoreElement.style.transition = 'transform 0.2s ease';
          scoreElement.style.transform = 'scale(1.1)';
          setTimeout(() => {
            scoreElement.style.transform = 'scale(1)';
          }, 200);
        }
      } else if (data.error) {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error voting:', error);
      alert('Failed to vote. Please try again.');
    });
  }

  // Character counter for main comment form
  document.addEventListener('DOMContentLoaded', function() {
    var mainTextarea = document.querySelector('.comment-form .comment-textarea');
    var mainCounter = document.getElementById('char-count-main');

    if (mainTextarea && mainCounter) {
      mainTextarea.addEventListener('input', function() {
        var length = this.value.length;
        mainCounter.textContent = length + ' / 2000';
        if (length > 1800) {
          mainCounter.style.color = '#ffa500';
        } else if (length >= 2000) {
          mainCounter.style.color = '#dc3545';
        } else {
          mainCounter.style.color = '';
        }
      });
    }

    // Auto-expand textareas as user types
    document.querySelectorAll('.comment-textarea, .reply-textarea').forEach(function(textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 400) + 'px';
      });
    });
  });
  </script>

  {% include '_footer.html' %}

  {% block javascript %}
  <script src="{% static 'js/theme-toggle.js' %}" defer></script>
  <script src="{% static 'js/base.js' %}" defer></script>

  <!-- Prism.js for syntax highlighting with plugins -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

  <script>
  // Add line numbers class to all code blocks
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('pre code').forEach(function(block) {
      if (!block.parentElement.classList.contains('line-numbers')) {
        block.parentElement.classList.add('line-numbers');
      }
    });

    // Re-run Prism highlighting after adding classes
    if (window.Prism) {
      Prism.highlightAll();
    }
  });
  </script>

  <style>
  /* Blog Tags Styling */
  .blog-tags-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--background-secondary, #f5f5f5);
    border-radius: 8px;
  }

  .blog-tags-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
  }

  .blog-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .blog-tag {
    display: inline-block;
    padding: 0.5rem 1rem;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    transition: transform 0.2s, opacity 0.2s;
  }

  .blog-tag:hover {
    transform: translateY(-2px);
    opacity: 0.9;
  }

  /* Related Posts Styling */
  .related-posts-section {
    margin: 2rem 0;
    padding: 1.5rem;
    border: 2px solid var(--border-color, #ddd);
    border-radius: 8px;
  }

  .related-posts-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
  }

  .related-posts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .related-post {
    padding: 1rem;
    background: var(--background-secondary, #f9f9f9);
    border-left: 3px solid var(--accent-color, #0066cc);
    border-radius: 4px;
  }

  .related-post h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
  }

  .related-post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .related-post-tag {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    color: white;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Code Block Enhancements */
  pre[class*="language-"] {
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .code-toolbar {
    position: relative;
    margin: 1.5rem 0;
  }

  .code-toolbar > .toolbar {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .code-toolbar:hover > .toolbar {
    opacity: 1;
  }

  .code-toolbar > .toolbar button {
    background: var(--accent-color, #0066cc);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
  }

  .code-toolbar > .toolbar button:hover {
    background: var(--accent-color-dark, #0052a3);
  }
  </style>
  {% endblock javascript %}
</body>

</html>
