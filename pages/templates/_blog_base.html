{% load static %}
{% load css_version %}
<!DOCTYPE html>
<html lang="en">

<head>
  {% include '_meta.html' %}
  <title>Aaronspindler.com - {{ blog_title }}</title>


  {% block css %}
  {% versioned_css as css_file %}
  <link rel="stylesheet" href="{% static css_file %}">
  <!-- Prism.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-twilight.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">

  <!-- Configure Prism before it loads -->
  <script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true; // Disable automatic highlighting
  </script>

  <!-- Override to fix token stacking issue from base.css * + * rule -->
  <style>
    /* Force all tokens to be inline and have no top margin */
    pre[class*="language-"] .token,
    code[class*="language-"] .token,
    pre[class*="language-"] span,
    code[class*="language-"] span {
      display: inline !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background: none !important;
      box-sizing: content-box !important;
    }

    /* Ensure comment tokens have no box styling */
    .token.comment,
    .token.block-comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
      display: inline !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background: none !important;
    }

    /* Remove any inherited borders from base CSS */
    code[class*="language-"] * {
      border: none !important;
      background: none !important;
    }

    /* Ensure Prism toolbar is visible and styled */
    div.code-toolbar {
      position: relative !important;
    }

    div.code-toolbar > .toolbar {
      position: absolute !important;
      top: 0 !important;
      right: 0 !important;
      display: block !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
      z-index: 10 !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background: none !important;
      box-shadow: none !important;
    }

    div.code-toolbar:hover > .toolbar {
      opacity: 1 !important;
    }

    div.code-toolbar > .toolbar > .toolbar-item {
      all: unset !important;
      display: inline-block !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    div.code-toolbar > .toolbar > .toolbar-item > a,
    div.code-toolbar > .toolbar > .toolbar-item > button,
    div.code-toolbar > .toolbar > .toolbar-item > span {
      all: unset !important;
      display: inline-block !important;
      box-sizing: border-box !important;
      margin: 0.5rem !important;
      padding: 0.4rem 0.8rem !important;
      background: rgba(224, 224, 224, 0.2) !important;
      color: #c5c8c6 !important;
      border: 1px solid rgba(224, 224, 224, 0.3) !important;
      font-family: var(--font-family) !important;
      font-size: 0.7rem !important;
      font-weight: var(--font-weight-medium) !important;
      text-transform: uppercase !important;
      cursor: pointer !important;
      border-radius: 0.25rem !important;
      transition: all 0.2s ease !important;
    }

    div.code-toolbar > .toolbar > .toolbar-item > a:hover,
    div.code-toolbar > .toolbar > .toolbar-item > button:hover,
    div.code-toolbar > .toolbar > .toolbar-item > span:hover {
      background: rgba(224, 224, 224, 0.35) !important;
      border-color: rgba(224, 224, 224, 0.5) !important;
    }
  </style>
  {% endblock %}
</head>

<body>
  {% include '_header.html' %}
  <div class="back-button">
    <a href="{% url 'home' %}#blog">Back</a>
    <br>
  </div>
  <table class="blog-metadata">
    <tr>
      <td colspan="2">{{ blog_title|safe }}</td>
    </tr>
    <tr>
      <th>Times Read</th>
      <td>{{ views }}</td>
    </tr>
    <tr>
      <th>Change Log</th>
      <td><a href="{{ github_link }}">View on Github</a></td>
    </tr>
  </table>
  {{ blog_content|safe }}

  <!-- Tags Section -->
  {% if tags %}
  <div class="blog-tags-section">
    <h3>Tags</h3>
    <div class="blog-tags">
      {% for tag in tags %}
      <a href="{% url 'search' %}?tag={{ tag.slug }}" class="blog-tag" style="background-color: {{ tag.color }};">
        {{ tag.name }}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Related Posts Section -->
  {% if related_posts %}
  <div class="related-posts-section">
    <h3>Related Posts</h3>
    <div class="related-posts">
      {% for post in related_posts %}
      <article class="related-post">
        <h4>
          <a href="/b/{{ post.category }}/{{ post.template_name }}/">
            {{ post.blog_title }}
          </a>
        </h4>
        {% if post.shared_tags %}
        <div class="related-post-tags">
          {% for tag in post.shared_tags %}
          <span class="related-post-tag" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Comments Section -->
  <div id="comments" class="comments-section">
    <h2>Comments ({{ comment_count }})</h2>

    {% if pending_comments_count and user.is_staff %}
    <div class="alert alert-info">
      <strong>Staff Notice:</strong> There are {{ pending_comments_count }} pending comments for this post.
      <a href="/admin/blog/blogcomment/?blog_template_name={{ template_name }}&status__exact=pending" target="_blank">Review in Admin</a>
    </div>
    {% endif %}

    {% include '_messages.html' %}

    <!-- Comment Form -->
    <div class="comment-form-container">
      <h3>Leave a Comment</h3>
      {% if user.is_authenticated %}
        <p class="comment-author-info">Commenting as <strong>{{ user.username }}</strong></p>
      {% else %}
        <p class="comment-author-info">You can comment anonymously or <a href="{% url 'account_login' %}?next={{ request.path }}">login</a> to use your account.</p>
      {% endif %}

      <form method="post" action="{% url 'submit_comment' category=category template_name=template_name %}" class="comment-form">
        {% csrf_token %}
        {{ comment_form.website }}  <!-- Honeypot field -->

        {% if not user.is_authenticated %}
        <div class="form-group">
          {{ comment_form.author_name.label_tag }}
          {{ comment_form.author_name }}
        </div>

        <div class="form-group">
          {{ comment_form.author_email.label_tag }}
          {{ comment_form.author_email }}
          <small class="form-text">{{ comment_form.author_email.help_text }}</small>
        </div>
        {% endif %}

        <div class="form-group">
          {{ comment_form.content.label_tag }}
          {{ comment_form.content }}
          <small class="form-text">{{ comment_form.content.help_text }} <span class="char-count" id="char-count-main">0 / 2000</span></small>
          {% if comment_form.content.errors %}
          <div class="form-errors">
            {{ comment_form.content.errors }}
          </div>
          {% endif %}
        </div>

        <button type="submit" class="btn-comment-submit">Post Comment</button>
      </form>
    </div>

    <!-- Display Comments -->
    <div class="comments-list">
      {% for comment in comments %}
        {% with is_reply=False depth=0 %}
          {% include "components/comment_thread.html" %}
        {% endwith %}
      {% empty %}
      <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
      {% endfor %}
    </div>
  </div>

  <script>
  function toggleReplyForm(commentId) {
    var form = document.getElementById('reply-form-' + commentId);
    if (form.style.display === 'none') {
      form.style.display = 'block';
      // Focus on the textarea when opening
      var textarea = form.querySelector('.reply-textarea');
      if (textarea) textarea.focus();
    } else {
      form.style.display = 'none';
    }
  }

  function voteComment(commentId, voteType) {
    // Check if user is authenticated (basic check)
    {% if not user.is_authenticated %}
    alert('Please login to vote on comments.');
    window.location.href = '{% url "account_login" %}?next=' + encodeURIComponent(window.location.pathname + '#comment-' + commentId);
    return;
    {% endif %}

    // Get CSRF token
    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send vote request
    fetch('/comment/' + commentId + '/vote/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: 'vote_type=' + voteType
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Update UI
        var votesContainer = document.querySelector('.comment-votes[data-comment-id="' + commentId + '"]');
        var scoreElement = document.querySelector('.vote-score[data-comment-id="' + commentId + '"]');

        if (votesContainer) {
          // Update button states
          var upvoteBtn = votesContainer.querySelector('.vote-btn.upvote');
          var downvoteBtn = votesContainer.querySelector('.vote-btn.downvote');

          // Remove active classes
          if (upvoteBtn) upvoteBtn.classList.remove('active');
          if (downvoteBtn) downvoteBtn.classList.remove('active');

          // Add active class to current vote
          if (data.user_vote === 'upvote' && upvoteBtn) {
            upvoteBtn.classList.add('active');
          } else if (data.user_vote === 'downvote' && downvoteBtn) {
            downvoteBtn.classList.add('active');
          }
        }

        // Update score in header
        if (scoreElement) {
          var scoreText = data.score > 0 ? '+' + data.score : data.score.toString();
          scoreElement.innerHTML = scoreText;

          // Update color classes
          scoreElement.classList.remove('positive', 'negative');
          if (data.score > 0) {
            scoreElement.classList.add('positive');
          } else if (data.score < 0) {
            scoreElement.classList.add('negative');
          }

          // Add a subtle animation to the score
          scoreElement.style.transition = 'transform 0.2s ease';
          scoreElement.style.transform = 'scale(1.1)';
          setTimeout(() => {
            scoreElement.style.transform = 'scale(1)';
          }, 200);
        }
      } else if (data.error) {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error voting:', error);
      alert('Failed to vote. Please try again.');
    });
  }

  // Character counter for main comment form
  document.addEventListener('DOMContentLoaded', function() {
    var mainTextarea = document.querySelector('.comment-form .comment-textarea');
    var mainCounter = document.getElementById('char-count-main');

    if (mainTextarea && mainCounter) {
      mainTextarea.addEventListener('input', function() {
        var length = this.value.length;
        mainCounter.textContent = length + ' / 2000';
        if (length > 1800) {
          mainCounter.style.color = '#ffa500';
        } else if (length >= 2000) {
          mainCounter.style.color = '#dc3545';
        } else {
          mainCounter.style.color = '';
        }
      });
    }

    // Auto-expand textareas as user types
    document.querySelectorAll('.comment-textarea, .reply-textarea').forEach(function(textarea) {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 400) + 'px';
      });
    });
  });
  </script>

  {% include '_footer.html' %}

  {% block javascript %}
  <script src="{% static 'js/base.js' %}" defer></script>

  <!-- Prism.js for syntax highlighting with plugins -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-SkmBfuA2hqjzEVpmnMt/LINrjop3GKWqsuLSSB3e7iBmYK7JuWw4ldmmxwD9mdm2IRTTi0OxSAfEGvgEi0i2Kw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js" integrity="sha512-st608h+ZqzliahyzEpETxzU0f7z7a9acN6AFvYmHvpFhmcFuKT8a22TT5TpKpjDa3pt3Wv7Z3SdQBCBdDPhyWA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
  // Add line-numbers class and trigger highlighting after all plugins load
  document.addEventListener('DOMContentLoaded', function() {
    // Add line-numbers class to all pre elements
    document.querySelectorAll('pre code').forEach(function(block) {
      block.parentElement.classList.add('line-numbers');
    });

    // Highlight all code blocks (toolbar and copy button will be added automatically)
    if (window.Prism) {
      Prism.highlightAll();
    }
  });
  </script>

  {% endblock javascript %}
</body>

</html>
