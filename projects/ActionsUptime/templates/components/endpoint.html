<div class="card mb-4 shadow-sm h-100" id="endpoint-card-{{ private_id }}">
    <div class="card-body d-flex flex-column">
        <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
            <h5 class="card-title mb-2 me-2">
                <span class="badge bg-secondary text-wrap endpoint-badge">
                    Loading...
                </span>
            </h5>
        </div>
        <p class="card-text mb-2">
            <i class="bi bi-clock"></i> Checked: <span class="endpoint-last-checked">Loading...</span>
            <span class="badge bg-secondary ms-2 endpoint-interval">Loading...</span>
        </p>
        <p class="card-text mb-2">
            <i class="bi bi-graph-up"></i> Success Rate: <span class="endpoint-success-rate">--</span>%
        </p>
        <p class="card-text mb-3">
            <i class="bi bi-speedometer2"></i> Average Latency: <span class="endpoint-average-latency">--</span> ms
        </p>
        <div class="mt-auto" style="height: 300px; overflow: hidden;">
            <ul class="nav nav-tabs" id="graphTabs-{{ private_id }}" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="status-tab-{{ private_id }}" data-bs-toggle="tab" data-bs-target="#status-{{ private_id }}" type="button" role="tab" aria-controls="status-{{ private_id }}" aria-selected="true">Status</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="latency-tab-{{ private_id }}" data-bs-toggle="tab" data-bs-target="#latency-{{ private_id }}" type="button" role="tab" aria-controls="latency-{{ private_id }}" aria-selected="false">Latency</button>
                </li>
            </ul>
            <div class="tab-content" id="graphTabsContent-{{ private_id }}" style="height: calc(100% - 42px);">
                <div class="tab-pane fade show active" id="status-{{ private_id }}" role="tabpanel" aria-labelledby="status-tab-{{ private_id }}" style="height: 100%; padding-top: 20px;">
                    {% include "components/endpoint_status_graph.html" with private_id=private_id %}
                </div>
                <div class="tab-pane fade" id="latency-{{ private_id }}" role="tabpanel" aria-labelledby="latency-tab-{{ private_id }}" style="height: 100%; padding-top: 20px;">
                    {% include "components/endpoint_latency_graph.html" with private_id=private_id %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal-{{ private_id }}" tabindex="-1" aria-labelledby="notificationModalLabel-{{ private_id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationModalLabel-{{ private_id }}">Notification Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="notificationMethods-{{ private_id }}">
                    Loading notification methods...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const endpointCard = document.getElementById('endpoint-card-{{ private_id }}');
        let endpointId;

        function updateEndpointCard() {
            fetch(`/web/details/{{ private_id }}`)
                .then(response => response.json())
                .then(data => {
                    // Update card with fetched data
                    endpointCard.querySelector('.endpoint-badge').innerHTML = `
                        <a href="${data.url}" class="text-decoration-none text-white">${data.url}</a>
                    `;
                    
                    const badge = endpointCard.querySelector('.endpoint-badge');
                    badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
                    badge.classList.add(data.last_status === 'success' ? 'bg-success' : 
                                        data.last_status === 'failure' ? 'bg-danger' : 'bg-secondary');
                    
                    // Update the interval
                    endpointCard.querySelector('.endpoint-interval').innerHTML = `<i class="bi bi-arrow-repeat"></i> ${data.interval}`;
                    
                    if (data.is_owner && !endpointCard.querySelector('.endpoint-owner-controls')) {
                        const ownerControls = `
                            <div class="dropdown endpoint-owner-controls">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#notificationModal-{{ private_id }}"><i class="bi bi-bell me-2"></i>Notifications</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/web/edit/${data.id}"><i class="bi bi-pencil-square me-2"></i>Edit</a></li>
                                    <li>
                                        <form class="endpoint-delete-form" method="post" action="/web/delete/${data.id}" onsubmit="return confirm('Are you sure you want to delete this endpoint?');">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Delete</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        `;
                        endpointCard.querySelector('.d-flex.flex-wrap').insertAdjacentHTML('beforeend', ownerControls);
                    }
                    
                    const lastChecked = new Date(data.last_checked);
                    const options = { 
                        year: 'numeric', month: 'numeric', day: 'numeric', 
                        hour: 'numeric', minute: 'numeric',
                        hour12: true
                    };
                    endpointCard.querySelector('.endpoint-last-checked').textContent = lastChecked.toLocaleString(undefined, options);
                    
                    endpointCard.querySelector('.endpoint-success-rate').textContent = data.success_rate;
                    endpointCard.querySelector('.endpoint-average-latency').textContent = data.average_latency;
                    
                    endpointId = data.id;
                })
                .catch(error => {
                    console.error('Error:', error);
                    endpointCard.querySelector('.card-body').innerHTML = '<p class="text-center text-muted">Failed to load endpoint data</p>';
                });
        }

        function loadNotificationMethods() {
            fetch(`/web/available_notification_methods/${endpointId}`)
                .then(response => response.json())
                .then(data => {
                    const methodsContainer = document.getElementById(`notificationMethods-{{ private_id }}`);
                    let html = '<h6>Email Notifications:</h6>';
                    data.emails.forEach(email => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email-${email.id}" ${email.enabled ? 'checked' : ''}>
                                ${email.email}
                            </div>
                        `;
                    });
                    html += '<h6 class="mt-3">Phone Notifications:</h6>';
                    data.phone_numbers.forEach(phone => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="phone-${phone.id}" ${phone.enabled ? 'checked' : ''}>
                                ${phone.phone_number}
                            </div>
                        `;
                    });
                    methodsContainer.innerHTML = html;

                    // Add event listeners to checkboxes
                    data.emails.forEach(email => {
                        document.getElementById(`email-${email.id}`).addEventListener('change', function() {
                            updateNotificationMethod('email', email.id, this.checked);
                        });
                    });
                    data.phone_numbers.forEach(phone => {
                        document.getElementById(`phone-${phone.id}`).addEventListener('change', function() {
                            updateNotificationMethod('phone', phone.id, this.checked);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading notification methods:', error);
                    document.getElementById(`notificationMethods-{{ private_id }}`).innerHTML = 'Failed to load notification methods';
                });
        }

        function updateNotificationMethod(type, id, enabled) {
            const url = enabled ? 
                `/web/add_${type}_notification/${endpointId}` : 
                `/web/remove_${type}_notification/${endpointId}`;
            const data = new FormData();
            data.append(`${type}_id`, id);
            fetch(url, {
                method: 'POST',
                body: data,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`${type} notification ${enabled ? 'added' : 'removed'} successfully`);
                } else {
                    console.error(`Failed to ${enabled ? 'add' : 'remove'} ${type} notification`);
                }
            })
            .catch(error => {
                console.error('Error updating notification method:', error);
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        updateEndpointCard();
        setInterval(updateEndpointCard, 60000); // Refresh every 1 minute

        // Load notification methods when the modal is shown
        const notificationModal = document.getElementById(`notificationModal-{{ private_id }}`);
        notificationModal.addEventListener('show.bs.modal', loadNotificationMethods);
    });
</script>